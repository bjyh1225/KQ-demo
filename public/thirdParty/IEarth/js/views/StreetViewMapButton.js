define(["jquery","Vue","Cesium"],function(e,t,i){"use strict";var n={streetView:"街景图",startStreetView:"开启腾讯街景图浏览",stopStreetView:"结束腾讯街景图浏览"};for(var o in n)n[o]=window.platformLanguage[o]?window.platformLanguage[o]:n[o];['<div class="street-view-map-button-content" :style="position">','<a :title="(active)?titles.stopStreetView:titles.startStreetView" class="cesium-button" @click="onToggleStreetViewMapClk"','style="width:32px;height:32px;border-radius:32px;padding:3px 6px;margin:0;background:rgba(38,38,38,0.75)">','<span v-if="active" class="iconfont icon-picture-w" style="display:inline-block;color:#0c84e4;font-weight: bold;"></span>','<span v-else class="iconfont icon-picture-w" style="display:inline-block;"></span>',"</a>","</div>"].join("");function a(t){t=i.defaultValue(t,{}),this._viewer=i.defaultValue(t.viewer,void 0),this._parentContainer=i.defaultValue(t.parentContainer,"cesiumContainer"),"string"==typeof this._parentContainer&&(this._parentContainer=e("#"+this._parentContainer)),this._parentContainer instanceof HTMLElement&&(this._parentContainer=e(this._parentContainer));var n=i.defaultValue(t.position,{bottom:155,right:10});this._position={},i.defined(n.top)?this._position.top=n.top+"px":i.defined(n.bottom)?this._position.bottom=n.bottom+"px":this._position.top="95px",i.defined(n.left)?this._position.left=n.left+"px":i.defined(n.right)?this._position.right=n.right+"px":this._position.right="10px",this._position.position="absolute";try{this._panoramaService=new qq.maps.PanoramaService}catch(e){console.warn(e)}this._pano=void 0,this._active=!1,this.initialize()}function r(e){(e=(e=i.Math.toDegrees(e))%360)<0&&(e+=360);var t=Number((e+11.25)/22.5).toFixed(0);return"images/icon/32/screen/"+("screen_r"+(t=t>15?0:t)+".png")}function s(e,t){var i=e.lng,n=e.lat,o=t.lng,a=t.lat,r=Math.acos((a-n)/Math.sqrt(Math.pow(o-i,2)+Math.pow(a-n,2)));return o-i<0&&(r=2*Math.PI-r),r/Math.PI*180}return a.prototype.initialize=function(){var o=this;if(this._vm=new t({data:{guid:o._id,titles:n,active:o._active,position:o._position},watch:{},methods:{onToggleStreetViewMapClk:function(){o.toggleActiveState(),this.active=o._active}}}),!document.getElementById("cesiumStreetViewMapContainer")){var a=['<div id="cesiumStreetViewMapContainer" class="cesium-street-view-map-container">','<div id="cesiumStreetViewMapCaption" class="caption">',"</div>",'<div id="cesiumStreetViewMapBar" class="toolbar">','<span class="iconfont icon-closed bar closebar" title="Close"></span>','<span class="iconfont icon-fullscreen bar fullscreenbar" title="FullScreen"></span>',"</div>","</div>"].join("");e("body").append(a),e("#cesiumStreetViewMapContainer .closebar").bind("click",function(){o.exitFullscreen(),o.close()}),e("#cesiumStreetViewMapContainer .fullscreenbar").bind("click",function(){o.toggleFullscreen()})}var r=document.getElementById("cesiumStreetViewMapContainer");try{o._pano=new qq.maps.Panorama(r,{pov:{heading:1,pitch:0},zoom:1,disableFullScreen:!1,photoTimeControl:!0,pano_changed:function(){if(o._loaded){var e=o._pano.getPosition();if(e){var t=new i.Cartesian3;i.Cartesian3.fromDegrees(e.lng,e.lat,0,o._viewer.scene.globe.ellipsoid,t),o._billboard.position=t}}}})}catch(e){console.warn(e)}this._billboards=new i.BillboardCollection,this._viewer.scene.primitives.add(this._billboards),this._billboard=this._billboards.add({show:!1,image:"images/icon/32/screen/screen_r0.png",verticalOrigin:i.VerticalOrigin.BOTTOM,width:48,height:48,disableDepthTestDistance:Number.MAX_VALUE}),this._billboardMove=this._billboards.add({show:!1,image:"images/icon/32/quanjing2.png",verticalOrigin:i.VerticalOrigin.BOTTOM,width:32,height:32,disableDepthTestDistance:Number.MAX_VALUE})},a.prototype.toggleActiveState=function(){this._active?(this.destroy(),this.close()):this.active()},a.prototype.active=function(){var e=this,t=new i.ScreenSpaceEventHandler(this._viewer.scene.canvas);t.setInputAction(function(t){var n=t.position,o=new i.Cartesian3;e.viewer.camera.pickEllipsoid(n,e.viewer.scene.globe.ellipsoid,o);var a=new i.Cartographic;i.Cartographic.fromCartesian(o,e.viewer.scene.globe.ellipsoid,a),e._billboard.position=o,e._billboard.show=!0,e.open(i.Math.toDegrees(a.longitude),i.Math.toDegrees(a.latitude))},i.ScreenSpaceEventType.LEFT_CLICK),t.setInputAction(function(t){var n=t.endPosition,o=new i.Cartesian3;e.viewer.camera.pickEllipsoid(n,e.viewer.scene.globe.ellipsoid,o),e._billboardMove.position=o,e._billboardMove.show=!0},i.ScreenSpaceEventType.MOUSE_MOVE),e._viewer.scene.camera.changed.addEventListener(function(){if(i.defined(e._billboard.oldRotation)){var t=e._viewer.camera.heading,n=e._billboard.oldRotation+t;e._billboard.image=r(n)}}),this._mousePickHandler=t,this._active=!0},a.prototype.destroy=function(){this._billboard.show=!1,this._billboardMove.show=!1,this._mousePickHandler.destroy(),this._active=!1},a.prototype.open=function(t,o){var a=this;a._loaded=!1;var l={lng:t,lat:o};a._panoramaService.getPano(l,200,function(t){if(t){var i={lng:t.latlng.lng,lat:t.latlng.lat};a._pano.setPov({heading:s(i,l),pitch:0}),a._pano.setPano(t.svid),a._loaded=!0,function(t){e("#cesiumStreetViewMapContainer").fadeIn(300),e("#cesiumStreetViewMapCaption").html(t.description?t.description:n.streetView),a._parentContainer.addClass("left"),a._parentContainer.animate({width:"50%"}),a._viewer.resize()}(t)}else a._billboard.image="images/icon/32/quanjing3.png"}),qq.maps.event.addListener(a._pano,"pov_changed",function(){var e=a._viewer.camera.heading;a._billboard.oldRotation=i.Math.toRadians(a._pano.getPov().heading);var t=a._billboard.oldRotation+e;a._billboard.image=r(t)})},a.prototype.close=function(){var t=this;e("#cesiumStreetViewMapContainer").fadeOut(300),t._parentContainer.removeClass("left"),t._parentContainer.animate({width:"100%"}),t._viewer.resize()},a.prototype.fullscreen=function(){var e=document.getElementById("cesiumStreetViewMapContainer");e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},a.prototype.exitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()},a.prototype.toggleFullscreen=function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?this.exitFullscreen():this.fullscreen()},i.defineProperties(a.prototype,{viewer:{get:function(){return this._viewer}},container:{get:function(){return this._container}},vm:{get:function(){return this._vm}}}),a});