define(["libs/common/common","libs/common/defined","libs/common/defaultValue","libs/common/defineProperties","jquery","Cesium","Vue","Bootstrap","views/Container"],function(e,a,t,i,n,o,r,m,l){"use strict";var s={aqi:"AQI指数",legend:"图例",heatmap:"热力图",dotmap:"散点图",dynamic:"动态模拟",dynamic24:"24小时数据",aqiLevel1:"优",aqiLevel2:"良",aqiLevel3:"轻度污染",aqiLevel4:"中度污染",aqiLevel5:"重度污染",aqiLevel6:"严重污染"};for(var d in s)s[d]=platformLanguage[d]?platformLanguage[d]:s[d];function p(a){a=t(a,{}),this._id=e.newGuid(),this._viewer=t(a.viewer,null),this._parentContainer=t(a.parentContainer,"cesiumContainer"),this._dynamic=t(a.dynamic,!1),this._dateRange=t(a.dateRange,void 0),this._mapStyle=t(a.mapStyle,"heatmap"),this._container=void 0,this._vm=void 0,this._workers={},this._rectangle=void 0,this._destroyed=!0,this._selfRemoved=!1,this._timer={container:void 0,vm:void 0},this._timeOut={},this._heatmap={heatmapImageryLayer:void 0,heatmapImageryProvider:void 0,handler:void 0,labelEntity:void 0},this._dotmap={circleImgCollection:[]},this._lang=e.getLocationRequestParam("lang")||"zh-CN",this._visualization={vm:void 0,index:void 0},this.updatePM25MapCameraMoveEnd();var i=this;this._viewer.imageryLayers.layerRemoved.addEventListener(function(e){i._selfRemoved?i._selfRemoved=!1:i._heatmap.heatmapImageryLayer.guid&&e.guid==i._heatmap.heatmapImageryLayer.guid&&(i.destroy(),i.followVisualizationVM())})}return p.prototype.acceptVisualizationVM=function(e,a){this._visualization.vm=e,this._visualization.index=a},p.prototype.followVisualizationVM=function(){var e=this._visualization.vm.visualizationItemsCollection[this._visualization.index];e.selected=!1,this._visualization.vm.$set(this._visualization.vm.visualizationItemsCollection,this._visualization.index,e)},p.prototype.getInitialImgData=function(){return new o.HeatmapImageryProvider({data:{min:0,max:0,points:[]},heatmapConfig:{gradient:{.05:"rgb(0, 228, 0)",.15:"rgb(256, 256, 0)",.25:"rgb(256, 126, 0)",.35:"rgb(256, 0, 0)",.5:"rgb(153, 0, 76)",.8:"rgb(126, 0, 35)"}}}).getLegendMap(500,500).image.imgData},p.prototype.addPM25MapImageryLayer=function(){this._viewer.scene.mode=o.SceneMode.SCENE3D,a(this._workers.pmWorker)&&this._workers.pmWorker.terminate(),clearTimeout(this._timeOut.pmTimmer),this._rectangle={},this._destroyed=!1;var e=this.getInitialImgData(),t=(new Date).getTime();this._dynamic&&a(this._dateRange)&&(t=this._dateRange[0]),this.startPM25Worker({name:"PM2.5",data:{min:0,max:0,points:[]},heatmapConfig:{xField:"lon",yField:"lat",valueField:"aqiValue"}},{},e,t)},p.prototype.startPM25Worker=function(t,i,n,o){var r=this,m=r._viewer.camera.computeViewRectangle();m!=r._rectangle&&(r._rectangle=m,i={north:e.radian2Degree(r._rectangle.north),south:e.radian2Degree(r._rectangle.south),east:e.radian2Degree(r._rectangle.east),west:e.radian2Degree(r._rectangle.west)},t.bounds=i);var l=i.south+","+i.west+","+i.north+","+i.east;r._workers.pmWorker=new Worker("js/workers/pmWorker.js"),r._workers.pmWorker.postMessage({bounds:l,imgData:n.data,date:o,lang:r._lang}),r._workers.pmWorker.onmessage=function(e){var m=e.data;"heatmap"==r._mapStyle?r.updatePM25Heatmap(m,t):"dotmap"==r._mapStyle&&r.updatePM25Dotmap(m,n),r._workers.pmWorker.terminate(),r._dynamic&&a(r._dateRange)&&(r._timeOut.pmTimmer=setTimeout(function(){(o+=36e5)>=r._dateRange[1]+36e5?o=r._dateRange[0]:o>=r._dateRange[1]&&(o=r._dateRange[1]),r.startPM25Worker(t,i,n,o)},5e3))}},p.prototype.updatePM25Heatmap=function(e,a){this._viewer.entities.removeAll();var t=this;a.data.min=e.min,a.data.max=e.max,a.data.points=e.entityTable,e.ok||(a.bounds=void 0);var i=new o.HeatmapImageryProvider(a);i.alpha=0;var n=t._viewer.imageryLayers.addImageryProvider(i);n.alpha=0;var r=0,m=setInterval(function(){r+=.1,t._heatmap.heatmapImageryLayer&&(t._heatmap.heatmapImageryLayer.alpha=1-r),n.alpha=r,r>=1&&(clearInterval(m),t._heatmap.heatmapImageryLayer&&(t._selfRemoved=!0,t._viewer.imageryLayers.remove(t._heatmap.heatmapImageryLayer)),t._heatmap.heatmapImageryLayer=n)},10);t.mousePickHeatmapValue(),t.addHeatmapLegend(),t.updatePM25MapLegend(i),t._heatmap.heatmapImageryProvider=i},p.prototype.updatePM25Dotmap=function(e,t){a(this._heatmap.heatmapImageryLayer)&&(this._selfRemoved=!0,this._viewer.imageryLayers.remove(this._heatmap.heatmapImageryLayer),this._heatmap.heatmapImageryLayer=void 0),this._viewer.entities.removeAll(),this._viewer.scene.globe.depthTestAgainstTerrain=!1;for(var i=e.entityTable,n=i.length-1;n>=0;n--){new o.Color(i[n].color.red,i[n].color.green,i[n].color.blue,.6);var r=this._dotmap.circleImgCollection[i[n].aqiValue];if(!a(r)){var m=document.createElement("canvas");m.width=16,m.height=16;var l=m.getContext("2d");l.fillStyle="#ffffff00",l.globalAlpha=0,l.fillRect(0,0,16,16);var s=t.data[4*i[n].aqiValue],d=t.data[4*i[n].aqiValue+1],p=t.data[4*i[n].aqiValue+2];l.globalAlpha=1,l.beginPath(),l.arc(8,8,8,0,2*Math.PI,!0),l.closePath();var h="rgb("+s+","+d+","+p+")";l.fillStyle=h,l.fill(),r=this._dotmap.circleImgCollection[i[n].aqiValue]=m}this._viewer.entities.add({position:o.Cartesian3.fromDegrees(i[n].lon,i[n].lat),billboard:{image:r.toDataURL(),show:!0},name:i[n].name||"unnamed",description:i[n].description})}this.addHeatmapLegend()},p.prototype.updatePM25MapCameraMoveEnd=function(){var e=this;e._viewer.scene.camera.moveEnd.addEventListener(function(){if(e._destroyed)return;e._dynamic&&a(e._dateRange)||e.addPM25MapImageryLayer()})},p.prototype.mousePickHeatmapValue=function(){var e=this;if(!a(e._heatmap.handler)){var t=e._viewer.scene,i=t.globe.ellipsoid;t.globe.depthTestAgainstTerrain=!1,e._heatmap.labelEntity=e._viewer.entities.add({label:{show:!1,font:"18px sans-serif"}}),e._heatmap.handler=new o.ScreenSpaceEventHandler(t.canvas),e._heatmap.handler.setInputAction(function(a){if(e._heatmap.heatmapImageryLayer){var t=e._viewer.camera.pickEllipsoid(a.endPosition,i);if(t){e._viewer.entities.contains(e._heatmap.labelEntity)||e._viewer.entities.add(e._heatmap.labelEntity);var n=i.cartesianToCartographic(t),r=o.Math.toDegrees(n.longitude),m=o.Math.toDegrees(n.latitude);e._heatmap.labelEntity.position=t,e._heatmap.labelEntity.label.show=!0;var l=e._heatmap.heatmapImageryLayer.imageryProvider.getValueAt(r,m);e._heatmap.labelEntity.label.text=String(l)}else e._heatmap.labelEntity.label.show=!1}},o.ScreenSpaceEventType.MOUSE_MOVE)}},p.prototype.startDynamic=function(){a(this._dateRange)?(this._dynamic=!0,this._workers.pmWorker.terminate(),clearTimeout(this._timeOut.pmTimmer),a(this._heatmap.heatmapImageryLayer)&&(this._selfRemoved=!0,this._viewer.imageryLayers.remove(this._heatmap.heatmapImageryLayer),this._heatmap.heatmapImageryLayer=void 0,this._heatmap.heatmapImageryProvider=void 0),this.addPM25MapImageryLayer()):console.log("please set date range")},p.prototype.addHeatmapLegend=function(){var e=this;if(a(e._container))this._container.shown=!0;else{var t=["<style>.pm25-map-content .dotmap .legend{height: 20px;text-align: center;padding:0;}</style>",'<div class="pm25-map-content" v-cloak>','<div style="text-align: left;" v-show="mapStyleShown">','<select class="cesium-button form-control" v-model="mapStyle">','<option value="heatmap">{{titles.heatmap}}</option>','<option value="dotmap">{{titles.dotmap}}</option>',"</select>",'<div style="margin: 5px 5px 0px 5px">','<label class="custom-label"><input type="checkbox" v-model="dynamicChecked"/>&nbsp;{{titles.dynamic24}}</label>',"</div>","</div>",'<div v-show="legendShown" style="text-align: center;">',"<h5>{{titles.legend}}</h5>",'<div style="width:150px" v-show="mapStyle==\'heatmap\'">','<span style="float: left;">{{heatmapLegend.min}}</span>','<span style="float: right;">{{heatmapLegend.max}}</span>',"</div>",'<div style="width:150px" v-show="mapStyle==\'heatmap\'">','<img :id="\'legend_gradient\'+guid" :src="heatmapLegend.gradientSrc"/>',"</div>",'<div style="width:150px" class="dotmap" v-show="mapStyle==\'dotmap\'">','<input class="form-control legend" title="0-50" v-model="dotmapLegend.level1" :style="{backgroundColor:dotmapLegend.color1}" readonly/>','<input class="form-control legend" title="51-100" v-model="dotmapLegend.level2" :style="{backgroundColor:dotmapLegend.color2}" readonly/>','<input class="form-control legend" title="101-150" v-model="dotmapLegend.level3" :style="{backgroundColor:dotmapLegend.color3}" readonly/>','<input class="form-control legend" title="151-200" v-model="dotmapLegend.level4" :style="{backgroundColor:dotmapLegend.color4}" readonly/>','<input class="form-control legend" title="201-300" v-model="dotmapLegend.level5" :style="{backgroundColor:dotmapLegend.color5}" readonly/>','<input class="form-control legend" title=">300" v-model="dotmapLegend.level6" :style="{backgroundColor:dotmapLegend.color6}" readonly />',"</div>","</div>","</div>"].join("");"string"==typeof this._parentContainer&&(e._parentContainer=n("#"+e._parentContainer));var i={parentContainer:e._parentContainer,title:s.aqi,content:t,shown:!0,showHeader:!0,showTitle:!0,showCloseBtn:!0,style:{position:"absolute",bottom:"150px",right:"15px"},draggable:!0};this._container=new l(i),this._vm=new r({el:".pm25-map-content",data:{guid:e._id,titles:s,mapStyle:e._mapStyle||"heatmap",dynamicChecked:!1,legendShown:!0,mapStyleShown:!0,heatmapLegend:{min:0,max:0,gradientSrc:""},dotmapLegend:{textAlign:"center",level1:s.aqiLevel1,color1:"green",level2:s.aqiLevel2,color2:"yellow",level3:s.aqiLevel3,color3:"orange",level4:s.aqiLevel4,color4:"red",level5:s.aqiLevel5,color5:"#BD0031",level6:s.aqiLevel6,color6:"maroon"}},watch:{dynamicChecked:function(){if(this.dynamicChecked){if(!a(e.dateRange)){var t=(new Date).getTime();e.dateRange=[t-864e5,t]}e.startDynamic()}else clearTimeout(e._timeOut.pmTimmer),e._workers.pmWorker.terminate(),e._dynamic=!1,e.addPM25MapImageryLayer()},mapStyle:function(){e._mapStyle=this.mapStyle,e._destroyed||e.addPM25MapImageryLayer()}}})}},p.prototype.updatePM25MapLegend=function(e){var a=e.getLegendMap();this._vm.heatmapLegend.min=Math.floor(a.min),this._vm.heatmapLegend.max=Math.floor(a.max),this._vm.heatmapLegend.gradientSrc=a.image.src},p.prototype.destroy=function(){this._workers.pmWorker.terminate(),clearTimeout(this._timeOut.pmTimmer),this._container.destroy(),this._container=void 0,this._destroyed=!0,a(this._heatmap.heatmapImageryLayer)&&(this._selfRemoved=!0,this._viewer.imageryLayers.remove(this._heatmap.heatmapImageryLayer),this._heatmap.heatmapImageryLayer=void 0,this._heatmap.heatmapImageryProvider=void 0,this._heatmap.handler=void 0),this._dynamic=!1,this._viewer.entities.removeAll()},i(p.prototype,{container:{get:function(){return this._container}},timmer:{get:function(){return this._timmer}},mapStyle:{get:function(){return this._mapStyle},set:function(e){this._mapStyle=e,this._vm.mapStyle=e}},mapStyleShown:{get:function(){return this._vm.mapStyleShown},set:function(e){this._vm.mapStyleShown=e}},legendShown:{get:function(){return this._vm.legendShown},set:function(e){this._vm.legendShown=e}},dateRange:{get:function(){return this._dateRange},set:function(e){this._dateRange=e}}}),p});