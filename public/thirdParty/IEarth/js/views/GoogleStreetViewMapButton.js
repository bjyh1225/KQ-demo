define(["jquery","Vue","Cesium"],function(e,t,i){"use strict";var o={startGoogleStreetView:"开启谷歌街景图浏览",stopGoogleStreetView:"结束谷歌街景图浏览",googleStreetMap:"谷歌街景地图"};for(var n in o)o[n]=window.platformLanguage[n]?window.platformLanguage[n]:o[n];['<div class="google-street-view-map-button-content" :style="position">','<a :title="(active)?titles.stopGoogleStreetView:titles.startGoogleStreetView" class="cesium-button" @click="onToggleStreetViewMapClk"','style="width:32px;height:32px;border-radius:32px;padding:3px 6px;margin:0;background:rgba(38,38,38,0.75)">','<span v-if="active" class="iconfont icon-picture-w" style="display:inline-block;color:#0c84e4;font-weight: bold;"></span>','<span v-else class="iconfont icon-picture-w" style="display:inline-block;"></span>',"</a>","</div>"].join("");function a(t){t=i.defaultValue(t,{}),this._viewer=i.defaultValue(t.viewer,void 0),this._parentContainer=i.defaultValue(t.parentContainer,"cesiumContainer"),"string"==typeof this._parentContainer&&(this._parentContainer=e("#"+this._parentContainer)),this._parentContainer instanceof HTMLElement&&(this._parentContainer=e(this._parentContainer));var o=i.defaultValue(t.position,{bottom:50,right:15});this._position={},i.defined(o.top)?this._position.top=o.top+"px":i.defined(o.bottom)?this._position.bottom=o.bottom+"px":this._position.top="95px",i.defined(o.left)?this._position.left=o.left+"px":i.defined(o.right)?this._position.right=o.right+"px":this._position.right="10px",this._position.position="absolute",this.rotation=i.defaultValue(t.rotation,void 0),this._pano=void 0,this._active=!1,this._imageryLayer=void 0}function r(e){(e=(e=i.Math.toDegrees(e))%360)<0&&(e+=360);var t=Number((e+11.25)/22.5).toFixed(0);return"images/icon/32/screen/"+("screen_r"+(t=t>15?0:t)+".png")}return a.prototype.initialize=function(){var n=this;if(this._vm=new t({data:{guid:n._id,titles:o,active:n._active,position:n._position},watch:{},methods:{onToggleStreetViewMapClk:function(){n.toggleActiveState(),this.active=n._active}}}),!document.getElementById("cesiumGoogleStreetViewMapContainer")){var a=['<div id="cesiumGoogleStreetViewMapContainer" class="cesium-street-view-map-container">','<div id="cesiumGoogleStreetViewMapCaption" class="caption">',"</div>",'<div id="cesiumGoogleStreetViewMapBar" class="toolbar">','<span class="iconfont icon-closed bar closebar" title="Close"></span>','<span class="iconfont icon-fullscreen bar fullscreenbar" title="FullScreen"></span>',"</div>","</div>"].join("");e("body").append(a),e("#cesiumGoogleStreetViewMapContainer .closebar").bind("click",function(){n.exitFullscreen(),n.close()}),e("#cesiumGoogleStreetViewMapContainer .fullscreenbar").bind("click",function(){n.toggleFullscreen()})}var r=document.getElementById("cesiumGoogleStreetViewMapContainer");try{this._pano=new google.maps.StreetViewPanorama(r,{position:{lat:37.86926,lng:-122.254811},pov:{heading:1,pitch:0},zoom:1})}catch(e){console.warn(e)}this._billboards=new i.BillboardCollection,this._viewer.scene.primitives.add(this._billboards),this._billboard=this._billboards.add({show:!1,image:"images/icon/32/screen/screen_r0.png",verticalOrigin:i.VerticalOrigin.BOTTOM,width:48,height:48,disableDepthTestDistance:Number.MAX_VALUE}),this._billboardMove=this._billboards.add({show:!1,image:"images/icon/32/quanjing2.png",verticalOrigin:i.VerticalOrigin.BOTTOM,width:32,height:32,disableDepthTestDistance:Number.MAX_VALUE})},a.prototype.toggleActiveState=function(){this._active?(this.destroy(),this.close()):this.active()},a.prototype.active=function(){var e=this,t={name:"谷歌街景地图",maptype:"streetmap"},o=new i.GoogleMapsImageryProvider(t),n=new i.ImageryLayer(o,t);n=this._viewer.imageryLayers.addImageryProvider(o);this._imageryLayer=n;var a=new i.ScreenSpaceEventHandler(this._viewer.scene.canvas);a.setInputAction(function(t){var o=t.position,n=new i.Cartesian3;e.viewer.camera.pickEllipsoid(o,e.viewer.scene.globe.ellipsoid,n);var a=new i.Cartographic;i.Cartographic.fromCartesian(n,e.viewer.scene.globe.ellipsoid,a),e._billboard.position=n,e._billboard.show=!0,e.open(i.Math.toDegrees(a.longitude),i.Math.toDegrees(a.latitude))},i.ScreenSpaceEventType.LEFT_CLICK),a.setInputAction(function(t){var o=t.endPosition,n=new i.Cartesian3;e.viewer.camera.pickEllipsoid(o,e.viewer.scene.globe.ellipsoid,n),e._billboardMove.position=n,e._billboardMove.show=!0},i.ScreenSpaceEventType.MOUSE_MOVE),e._viewer.scene.camera.changed.addEventListener(function(){if(i.defined(e._billboard.oldRotation)){var t=e._viewer.camera.heading,o=e._billboard.oldRotation+t;e._billboard.image=r(o)}}),this._mousePickHandler=a,e._active=!0},a.prototype.destroy=function(){this._billboard.show=!1,this._billboardMove.show=!1,this._mousePickHandler.destroy(),this._viewer.imageryLayers.remove(this._imageryLayer),this._active=!1},a.prototype.open=function(t,o){var n=this;n._loaded=!1;var a={lng:t,lat:o},s=n._viewer.camera.positionCartographic.height/1e3;(s=20*(s+1))>1e4&&(s=1e4),this._panoramaService.getPanorama({location:a,radius:s},function(t,i){if("200"){if(!t)return;n._pano.setPano(t.location.pano),n._pano.setPov({heading:270,pitch:0}),e("#cesiumGoogleStreetViewMapContainer").fadeIn(300),n._parentContainer.addClass("left"),n._parentContainer.animate({width:"50%"}),n._viewer.resize(),setTimeout(function(){n._pano.setVisible(!0),document.getElementsByClassName("gmnoprint gm-bundled-control gm-bundled-control-on-bottom")[0].children[0].style.top="60px"},300)}else n._billboard.image="images/icon/32/quanjing3.png"}),n._pano.addListener("pov_changed",function(){var e=n._viewer.camera.heading;n._billboard.oldRotation=i.Math.toRadians(n._pano.getPov().heading);var t=n._billboard.oldRotation+e;n._billboard.image=r(t)}),n._pano.addListener("position_changed",function(){if(i.defined(n._pano.getPosition().lat())&&i.defined(n._pano.getPosition().lng())){var e=new i.Cartographic(i.Math.toRadians(n._pano.getPosition().lng()),i.Math.toRadians(n._pano.getPosition().lat()),0),t=i.Cartographic.toCartesian(e,n.viewer.scene.globe.ellipsoid);n._billboard.position=t}})},a.prototype.close=function(){var t=this;e("#cesiumGoogleStreetViewMapContainer").fadeOut(300),t._parentContainer.removeClass("left"),t._parentContainer.animate({width:"100%"}),t._viewer.resize()},a.prototype.fullscreen=function(){var e=document.getElementById("cesiumGoogleStreetViewMapContainer");e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()},a.prototype.exitFullscreen=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen()},a.prototype.toggleFullscreen=function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?this.exitFullscreen():this.fullscreen()},i.defineProperties(a.prototype,{viewer:{get:function(){return this._viewer}},container:{get:function(){return this._container}},vm:{get:function(){return this._vm}}}),a});