define(["text!views/html/AddData.html","libs/common/common","libs/common/defined","libs/common/defaultValue","libs/common/defineProperties","jquery","Cesium","Vue","VueLazyLoad","Bootstrap","views/Container","views/Enum","views/DataSourceConfig","views/OGCServerParser"],function(e,a,t,r,i,s,o,n,c,l,d,m,u,y){"use strict";window.platformLanguage||(window.platformLanguage={});var p=window.platformLanguage,v={dataOnline:"在线数据",file:"文件",url:"URL地址",allData:"所有数据",inputKeyword:"输入关键词...",inputName:"输入名称...",inputUrl:"输入URL地址...",search:"搜索",selectFiles:"选择文件",clearFiles:"清空文件",loadFiles:"加载",type:"类型",name:"名称",ok:"确定",cancel:"取消",dragFileToArea:"将文件拖拽至此区域.",dropMouse:"释放鼠标",unKnownImagery:"未命名的影像图层",unKnownLayer:"未命名的图层",selectWorkspace:"请选择工作空间",selectDataset:"请选择数据集",selectDataclass:"请选数据类",selectLayer:"请选择图层",layerName:"图层名称",workspaceName:"工作空间名称",datasetName:"数据集名称",dataclassName:"数据类名称",connect:"连接",heightOffset:"高度偏移",isKq3dServer:"是否苍穹三维服务"};for(var S in v)v[S]=window.platformLanguage[S]?window.platformLanguage[S]:v[S];var g={fileExtensions:["json","geojson","topojson","kml","kmz","czml"],selectedFiles:[]},h=[{type:m.eDataSourceType.KQGIS3DTileFileImagery,name:p.KQGIS3DTileFileImagery||"KQGIS3D影像瓦片文件服务"},{type:m.eDataSourceType.KQGIS3DServerImagery,name:p.KQGIS3DServerImagery||"KQGIS3D影像瓦片服务"},{type:m.eDataSourceType.KQGIS3DTileFileTerrain,name:p.KQGIS3DTileFileTerrain||"KQGIS3D地形瓦片文件服务"},{type:m.eDataSourceType.KQGIS3DServerTerrain,name:p.KQGIS3DServerTerrain||"KQGIS3D地形瓦片服务"},{type:m.eDataSourceType.CesiumTerrain,name:p.CesiumTerrain||"STK Terrain"},{type:m.eDataSourceType.Cesium3DTileset,name:p.Cesium3DTileset||"Cesium3DTileset"},{type:m.eDataSourceType.ArcGISMapServerImagery,name:p.ArcGISMapServerImagery||"ArcGIS Map Server"},{type:m.eDataSourceType.KQGISMapServerImagery,name:p.KQGISMapServerImagery||"KQGIS Map Server"},{type:m.eDataSourceType.WebMapServiceImagery,name:p.WebMapServiceImagery||"OGC WMS"},{type:m.eDataSourceType.WebMapTileServiceImagery,name:p.WebMapTileServiceImagery||"OGC WMTS"}];function T(t){t=r(t,{}),this._viewer=r(t.viewer,null),this._parentContainer=r(t.parentContainer,"cesiumContainer"),this._title=r(window.platformLanguage.addData,"添加数据"),this._content=r(e,""),this._shown=r(t.shown,!0),this._showHeader=r(t.showHeader,!0),this._showTitle=r(t.showTitle,!0),this._showCloseBtn=r(t.showCloseBtn,!0),this._style=r(t.style,{position:"absolute",top:"0",left:"0",margin:"0",width:"auto"}),this._style.zIndex=999,this._bodyStyle=r(t.bodyStyle,{padding:"5px",margin:0}),this._draggable=r(t.draggable,!0),this._container=null,this._vm=null,this._id=a.newGuid(),this.initialize(t)}function b(e){var a=document.createElement("div");globalViewer.container.appendChild(a),a.className="backdrop",a.style.display="none",a.style.position="absolute",a.style.bottom="0",a.style.left="0",a.style["pointer-events"]="none",a.style.padding="4px",a.style.backgroundColor="black";var t={feature:void 0,originalColor:new o.Color},r={feature:void 0,originalColor:new o.Color},i=new o.Entity;e.screenSpaceEventHandler.setInputAction(function(e){},o.ScreenSpaceEventType.MOUSE_MOVE);var s=e.screenSpaceEventHandler.getInputAction(o.ScreenSpaceEventType.LEFT_CLICK);e.screenSpaceEventHandler.setInputAction(function(e){o.defined(t.feature)&&(t.feature.color=t.originalColor,t.feature=void 0);var a=globalViewer.scene.pick(e.position);if(o.defined(a)&&a instanceof o.Cesium3DTileFeature){t.feature=a,a===r.feature?(o.Color.clone(r.originalColor,t.originalColor),r.feature=void 0):o.Color.clone(a.color,t.originalColor),a.color=o.Color.LIME;var n=a.getPropertyNames()||[],c="Feature Property";n.indexOf("name")&&(c=a.getProperty("name")),i.name=c,i.description='Loading <div class="cesium-infoBox-loading"></div>',globalViewer.selectedEntity=i;var l="";n.forEach(function(e){"id"!==e.toLowerCase()&&(l=l+"<tr><th>"+e+"</th><td>"+a.getProperty(e)+"</td></tr>")}),i.description='<table class="cesium-infoBox-defaultTable"><tbody>'+l+"</tbody></table>"}else s(e)},o.ScreenSpaceEventType.LEFT_CLICK)}return T.prototype.initialize=function(e){var t=r(e.parentContainer,"cesiumContainer");this._parentContainer=r(t,""),this._viewer=r(e.viewer,null),this._style=r(e.style,void 0);var i={parentContainer:this._parentContainer,title:this._title,content:this._content,shown:this._shown,showHeader:this._showHeader,showTitle:this._showTitle,showCloseBtn:this._showCloseBtn,style:this._style,bodyStyle:this._bodyStyle,draggable:this._draggable};this._container=new d(i);var o=this,l=u.DataTypeKeyMap;n.use(c,{error:"images/imageLayer/nopicture.jpg",loading:"images/lazy-loading.gif"}),this._vm=new n({el:".module-add-data-content",data:{guid:o._id,dataSourceTypeList:m.eDataSourceType,dataSourceSettings:u.DataSourceSettings,dataTypeListOnline:l,titles:v,dataType:"online",dataTypeNameOnline:v.allData,dataTypeOnline:u.DataTypeKeyMap.allData.type,keyword:"",selectedFiles:[],urlParams:{type:h[0].type,typeName:h[0].name,uiStyle:0,url:"",defaultUrl:"http://127.0.0.1:9090/services/kq3dservice",isKq3dServer:0,name:"",workspaceName:v.selectWorkspace,workspaceId:-1,workspaceNameList:[],datasetName:v.selectDataset,datasetId:-1,datasetNameList:[],datasetType:"raster",dataclassName:v.selectDataclass,datasetclass:-1,dataclassNameList:[],dataclassType:"cesium3dtile",heightOffset:0,ogcLayerName:v.selectLayer,ogcLayerNameId:-1,ogcLayerNameList:[]},URLSupportDataSourceTypeList:h},watch:{},created:function(){var e=s(".module-add-data-content .dropdown-menu").css("backgroundColor").toLowerCase();if(e.indexOf("rgba")>-1){var a=e.replace(/ /g,"").replace("rgba(","").replace(")","").split(",");a[3]=1,s(".module-add-data-content .dropdown-menu").css("backgroundColor","rgba("+a.join(",")+")")}},methods:{onTabsToggle:function(e){this.dataType=e},onDataSourceItemsClk:function(e){o.addAndRemoveSceneDataLayer(e)},onToggleDataTypeOnlineClk:function(e,a){if(this.keyword="",this.dataTypeNameOnline=a,this.dataTypeOnline=e,e==u.DataTypeKeyMap.allData.type)this.dataSourceSettings=u.DataSourceSettings;else{this.dataSourceSettings=[];for(var t=0;t<u.DataSourceSettings.length;t++){var r=u.DataSourceSettings[t];r.type==e&&this.dataSourceSettings.push(r)}}},searchDataOnlineByKeyword:function(){var e=a.trim(this.keyword);this.dataSourceSettings=[];for(var t=0;t<u.DataSourceSettings.length;t++){var r=u.DataSourceSettings[t];this.dataTypeOnline==u.DataTypeKeyMap.allData.type?r.name.toLowerCase().indexOf(e)>-1&&this.dataSourceSettings.push(r):r.type==this.dataTypeOnline&&r.name.toLowerCase().indexOf(e)>-1&&this.dataSourceSettings.push(r)}},onSelectFilesBtnClk:function(){document.getElementById("addData_selected_file_"+this.guid).click()},onClearAllFilesBtnClk:function(){this.selectedFiles=[],g.selectedFiles=[]},onLoadFilesBtnClk:function(){o.parseSeletedFiles()},onUrlDataTypeListClk:function(e){this.urlParams.type=e.type,this.urlParams.typeName=e.name},onUrl3DServerChkBoxClk:function(e){var a=e.target.checked?4:0;this.$set(this.urlParams,"uiStyle",a),e.target.checked&&-1==this.urlParams.url.toLowerCase().indexOf("kq3dservice")&&this.$set(this.urlParams,"url",this.urlParams.defaultUrl)},onWorkspaceNameListClk:function(e){this.$set(this.urlParams,"workspaceName",e.name),this.$set(this.urlParams,"workspaceId",e.id)},onDatasetNameListClk:function(e){this.$set(this.urlParams,"datasetName",e.name),this.$set(this.urlParams,"datasetId",e.id)},onDataclassNameListClk:function(e){this.$set(this.urlParams,"dataclassName",e.name),this.$set(this.urlParams,"dataclassId",e.id)},onConnectKq3dServerClk:function(){this.urlParams.url?o.getKQ3DServerWorkspaceNames(this.urlParams.url):alert("Please input the url.")},onConnectOGCServerClk:function(){o.getOGCServerLayerList(this.urlParams.type,this.urlParams.url)},onOGCLayerNameListClk:function(e,a){this.$set(this.urlParams,"ogcLayerName",e.title||e.name),this.$set(this.urlParams,"ogcLayerNameId",a)},onUrlOkBtnClk:function(){this.urlParams.url?o.loadURLDataToScene():alert("Please input the url.")},onUrlCancelBtnClk:function(){o.shown=!1}}}),this._vm.$watch("urlParams.type",function(e,a){var t=[m.eDataSourceType.KQGIS3DServerImagery,m.eDataSourceType.KQGIS3DServerTerrain],r=[m.eDataSourceType.WebMapTileServiceImagery,m.eDataSourceType.WebMapServiceImagery];t.indexOf(e)>-1?(-1==o._vm.urlParams.url.toLowerCase().indexOf("kq3dservice")&&o._vm.$set(o._vm.urlParams,"url",o._vm.urlParams.defaultUrl),o._vm.$set(o._vm.urlParams,"uiStyle",1)):r.indexOf(e)>-1?o._vm.$set(o._vm.urlParams,"uiStyle",3):o._vm.$set(o._vm.urlParams,"uiStyle",0),e==m.eDataSourceType.Cesium3DTileset?(o._vm.$set(o._vm.urlParams,"uiStyle",o._vm.urlParams.isKq3dServer?4:0),o._vm.$set(o._vm.urlParams,"datasetType","cesium3dtile"),o._vm.$set(o._vm.urlParams,"dataclassType","cesium3dtile")):(o._vm.$set(o._vm.urlParams,"datasetType","raster"),o._vm.$set(o._vm.urlParams,"dataclassType","raster"))},{deep:!0,immediate:!0}),this._vm.$watch("urlParams.url",function(e,a){o._vm.$set(o._vm.urlParams,"workspaceNameList",[]),o._vm.$set(o._vm.urlParams,"ogcLayerNameList",[])},{deep:!0,immediate:!0}),this._vm.$watch("urlParams.workspaceNameList",function(e,a){e&&e.length>0?(o._vm.$set(o._vm.urlParams,"workspaceName",e[0].name),o._vm.$set(o._vm.urlParams,"workspaceId",e[0].id)):(o._vm.$set(o._vm.urlParams,"workspaceName",v.selectWorkspace),o._vm.$set(o._vm.urlParams,"workspaceId",-1))},{deep:!0,immediate:!0}),this._vm.$watch("urlParams.workspaceId",function(e,a){if(o._vm.$set(o._vm.urlParams,"datasetNameList",[]),-1!=e){o.getKQ3DServerDatasetNames(o._vm.urlParams.url,e,"tile")}},{deep:!0,immediate:!0}),this._vm.$watch("urlParams.datasetNameList",function(e,a){e&&e.length>0?(o._vm.$set(o._vm.urlParams,"datasetName",e[0].name),o._vm.$set(o._vm.urlParams,"datasetId",e[0].id)):(o._vm.$set(o._vm.urlParams,"datasetName",v.selectDataset),o._vm.$set(o._vm.urlParams,"datasetId",-1))},{deep:!0,immediate:!0}),this._vm.$watch("urlParams.datasetId",function(e,a){if(o._vm.$set(o._vm.urlParams,"dataclassNameList",[]),-1!=e){var t=o._vm.urlParams.dataclassType;o.getKQ3DServerDataclassNames(o._vm.urlParams.url,e,t)}},{deep:!0,immediate:!0}),this._vm.$watch("urlParams.dataclassNameList",function(e,a){e&&e.length>0?(o._vm.$set(o._vm.urlParams,"dataclassName",e[0].name),o._vm.$set(o._vm.urlParams,"dataclassId",e[0].id)):(o._vm.$set(o._vm.urlParams,"dataclassName",v.selectDataclass),o._vm.$set(o._vm.urlParams,"dataclassId",-1))},{deep:!0,immediate:!0}),this._vm.$watch("urlParams.ogcLayerNameList",function(e,a){e&&e.length>0?(o._vm.$set(o._vm.urlParams,"ogcLayerName",e[0].name),o._vm.$set(o._vm.urlParams,"ogcLayerNameId",0)):(o._vm.$set(o._vm.urlParams,"ogcLayerName",v.selectLayer),o._vm.$set(o._vm.urlParams,"ogcLayerNameId",-1))},{deep:!0,immediate:!0}),this.listenSceneObjectRemoved(),this.initFileSourceComponent()},T.prototype.addAndRemoveSceneDataLayer=function(e){var a=this.vm.dataSourceSettings[e];if(!a.unRemoved){var t=this.getDataSourceByOptions(a);switch(t.type){case m.eObjectType.ImageryProvider:this.addAndRemoveImageryLayer(e,t);break;case m.eObjectType.TerrainProvider:this.addAndRemoveTerrainLayer(e,t);break;case m.eObjectType.DataSource:this.addAndRemoveDataSource(e,t);break;case m.eObjectType.Cesium3DTileset:this.addAndRemoveCesium3DTileset(e,t)}}},T.prototype.addAndRemoveImageryLayer=function(e,a){var t=this.vm.dataSourceSettings[e];if(!t.unRemoved){var r=this._viewer.imageryLayers.getLayerByGuid(t.guid||"");r?(this._viewer.imageryLayers.remove(r),t.selected=!1,this.vm.$set(this.vm.dataSourceSettings,e,t)):(a.object&&(r=new o.ImageryLayer(a.object,{show:!0,name:t.name})),r&&(this._viewer.imageryLayers.add(r),r.getViewableRectangle().then(function(e){}),t.guid=r.guid,t.selected=!0,this.vm.$set(this.vm.dataSourceSettings,e,t)))}},T.prototype.addAndRemoveTerrainLayer=function(e,a){var t=this.vm.dataSourceSettings[e];if(!t.unRemoved){var r=a.object;t.selected?(r=new o.EllipsoidTerrainProvider({}),this._viewer.terrainProvider=r,t.selected=!1,this.vm.$set(this.vm.dataSourceSettings,e,t)):r&&(this._viewer.terrainProvider=r,t.selected=!0,this.vm.$set(this.vm.dataSourceSettings,e,t))}},T.prototype.addAndRemoveDataSource=function(e,a){var r=this;t(r._dataSources)||(r._dataSources={});var i=r._dataSources[e];t(i)||(i=a.object);var s=r._viewer.dataSources,o=r.vm.dataSourceSettings[e];o.unRemoved||(s.contains(i)?(s.remove(i),o.selected=!1,r.vm.$set(r.vm.dataSourceSettings,e,o)):a.object&&s.add(i).then(function(a){r._viewer.flyTo(a.entities,{duration:1.5}),r._dataSources[e]=a,o.selected=!0,o.guid=a.guid,r.vm.$set(r.vm.dataSourceSettings,e,o)}).otherwise(function(e){}))},T.prototype.addAndRemoveCesium3DTileset=function(e,a){var r=this;t(r._cesiumTilesets)||(r._cesiumTilesets={});var i=r._cesiumTilesets[e];t(i)||(i=a.object);var s=r._viewer.scene.primitives,n=r.vm.dataSourceSettings[e];n.unRemoved||(s.contains(i)?(s.remove(i),n.selected=!1,r.vm.$set(r.vm.dataSourceSettings,e,n)):a.object&&(i=s.add(a.object),r._cesiumTilesets[e]=a.object,i.readyPromise.then(function(){var e=i.boundingSphere;r._viewer.camera.flyToBoundingSphere(e,{duration:1.5}),n.style&&(i.style=new o.Cesium3DTileStyle(n.style)),n.enablePickFeatures&&b(r._viewer);var a=Number(r.vm.urlParams.heightOffset),t=(e=i.boundingSphere,o.Cartographic.fromCartesian(e.center)),s=o.Cartesian3.fromRadians(t.longitude,t.latitude,0),c=o.Cartesian3.fromRadians(t.longitude,t.latitude,a),l=o.Cartesian3.subtract(c,s,new o.Cartesian3);i.modelMatrix=o.Matrix4.fromTranslation(l)}).otherwise(function(e){}),n.selected=!0,n.guid=i.guid,r.vm.$set(r.vm.dataSourceSettings,e,n)))},T.prototype.getDataSourceByOptions=function(e){var a={type:void 0,object:void 0};switch((e=r(e,{})).dataSourceType||void 0){case m.eDataSourceType.SingleTileImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.SingleTileImageryProvider(e);break;case m.eDataSourceType.OverlayImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.OverlayImageryProvider(e);break;case m.eDataSourceType.BingMapsImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.BingMapsImageryProvider(e);break;case m.eDataSourceType.MapBoxImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.MapboxImageryProvider(e);break;case m.eDataSourceType.OpenStreetMapImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.createOpenStreetMapImageryProvider(e);break;case m.eDataSourceType.TileMapServiceImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.createTileMapServiceImageryProvider(e);break;case m.eDataSourceType.GoogleMapsImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.GoogleMapsImageryProvider(e);break;case m.eDataSourceType.AMapsImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.AMapsImageryProvider(e);break;case m.eDataSourceType.QQMapsImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.QQMapsImageryProvider(e);break;case m.eDataSourceType.BaiduMapsImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.BaiduMapsImageryProvider(e);break;case m.eDataSourceType.TiandituImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.TiandituImageryProvider(e);break;case m.eDataSourceType.ArcGISMapServerImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.ArcGisMapServerImageryProvider(e);break;case m.eDataSourceType.KQGISMapServerImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.KQGISMapServerImageryProvider(e);break;case m.eDataSourceType.KQGIS3DTileFileImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.KQGIS3DTileFileImageryProvider(e);break;case m.eDataSourceType.KQGIS3DServerImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.KQGIS3DServerImageryProvider(e);break;case m.eDataSourceType.WebMapServiceImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.WebMapServiceImageryProvider(e);break;case m.eDataSourceType.WebMapTileServiceImagery:a.type=m.eObjectType.ImageryProvider,a.object=e.selected?void 0:new o.WebMapTileServiceImageryProvider(e);break;case m.eDataSourceType.EllipsoidTerrain:a.type=m.eObjectType.TerrainProvider,a.object=e.selected?void 0:new o.EllipsoidTerrainProvider(e);break;case m.eDataSourceType.CesiumTerrain:a.type=m.eObjectType.TerrainProvider,a.object=e.selected?void 0:new o.CesiumTerrainProvider(e);break;case m.eDataSourceType.GoogleEarthEnterpriseTerrain:a.type=m.eObjectType.TerrainProvider,a.object=e.selected?void 0:new o.GoogleEarthEnterpriseTerrainProvider(e);break;case m.eDataSourceType.VRTheWorldTerrain:a.type=m.eObjectType.TerrainProvider,a.object=e.selected?void 0:new o.VRTheWorldTerrainProvider(e);break;case m.eDataSourceType.KQGIS3DTileFileTerrain:a.type=m.eObjectType.TerrainProvider,a.object=e.selected?void 0:new o.KQGIS3DTileFileTerrainProvider(e);break;case m.eDataSourceType.KQGIS3DServerTerrain:a.type=m.eObjectType.TerrainProvider,a.object=e.selected?void 0:new o.KQGIS3DServerTerrainProvider(e);break;case m.eDataSourceType.Cesium3DTileset:a.type=m.eObjectType.Cesium3DTileset,a.object=e.selected?void 0:new o.Cesium3DTileset(e);break;case m.eDataSourceType.GeoJsonDataSource:a.type=m.eObjectType.DataSource,a.object=e.selected?void 0:new o.GeoJsonDataSource.load(e.url,e);break;case m.eDataSourceType.GeoJsonExtendDataSource:a.type=m.eObjectType.DataSource,a.object=e.selected?void 0:new o.GeoJsonExtendDataSource.load(e.url,e);break;case m.eDataSourceType.KmlDataSource:e.camera=this._viewer.scene.camera,e.canvas=this._viewer.scene.canvas,a.type=m.eObjectType.DataSource,a.object=e.selected?void 0:new o.KmlDataSource.load(e.url,e);break;case m.eDataSourceType.CzmlDataSource:a.type=m.eObjectType.DataSource,a.object=e.selected?void 0:new o.CzmlDataSource.load(e.url,e)}return a},T.prototype.listenSceneObjectRemoved=function(){var e=this,a=this._viewer.imageryLayers,t=this._viewer.scene.primitives,r=this._viewer.dataSources;a.layerRemoved.addEventListener(function(a){e.updateVMSelectedStateByGuid(a.guid,!1)},{}),t.primitiveRemoved.addEventListener(function(a){e.updateVMSelectedStateByGuid(a.guid,!1)},{}),r.dataSourceRemoved.addEventListener(function(a,t){e.updateVMSelectedStateByGuid(t.guid,!1)},{})},T.prototype.updateVMSelectedStateByGuid=function(e,a){var t=this;t.vm.dataSourceSettings.forEach(function(r,i){if(r.guid&&r.guid==e)return r.selected=a,void t.vm.$set(t.vm.dataSourceSettings,i,r)})},T.prototype.initFileSourceComponent=function(){var e=this,a=document.getElementById("addData_drag_files_"+e._id),t=document.getElementById("addData_drag_tips_"+e._id);a.addEventListener("dragenter",function(){t.innerHTML=v.dropMouse},!1),a.addEventListener("dragleave",function(){t.innerHTML=v.dragFileToArea},!1),a.addEventListener("dragover",function(e){e.preventDefault()},!1),a.addEventListener("drop",function(e){e.preventDefault(),t.innerHTML=v.dragFileToArea,console.log(e.dataTransfer.files);for(var a=e.dataTransfer.files,r=0;r<a.length;r++){var s=a[r];i(s)}},!1);var r=document.getElementById("addData_selected_file_"+e._id);r.accept="."+g.fileExtensions.join(",."),r.addEventListener("change",function(){for(var e=r.files,a=0;a<e.length;a++){var t=e[a];i(t)}r.value=""},!1);var i=function(a){var t=a.name.replace(/(.*\/)*([^.]+).*/gi,"$2"),r=a.name.replace(/.+\./,"").toLowerCase();g.fileExtensions.indexOf(r)>-1&&(e.vm.selectedFiles.push({name:t,ext:r,fullName:a.name}),a.ext=r,g.selectedFiles.push(a))}},T.prototype.parseSeletedFiles=function(){var e=this,a=function(a,r){var i=new FileReader;i.readAsBinaryString(a),i.onload=function(){var s=i.result,n=a.name.replace(/.+\./,"").toLowerCase(),c=a.name.replace(/(.*\/)*([^.]+).*/gi,"$2");switch(n){case"json":case"geojson":case"topojson":s=(s=s.replace(/(^\s*)|(\s*$)/,"")).substring(s.indexOf("{"));try{"object"==typeof(d=JSON.parse(s))&&d&&(s=d)}catch(e){}e._viewer.dataSources.add(o.GeoJsonExtendDataSource.load(s,{name:c,style:"point"}));break;case"kml":s=s.replace(/(^\s*)|(\s*$)/,"");var l={name:c,camera:e._viewer.scene.camera,canvas:e._viewer.scene.canvas},d=new Blob([s],{type:"text/xml"});e._viewer.dataSources.add(o.KmlDataSource.load(d,l));break;case"kmz":l={name:c,camera:e._viewer.scene.camera,canvas:e._viewer.scene.canvas},e._viewer.dataSources.add(o.KmlDataSource.load(a,l));break;case"czml":s=s.replace(/(^\s*)|(\s*$)/,"");try{"object"==typeof(d=JSON.parse(s))&&d&&(s=d)}catch(e){}e._viewer.dataSources.add(o.CzmlDataSource.load(s,{name:c}))}t(r)},i.onerror=function(){console.log(a.name+"read error."),t(r)}};function t(a){g.selectedFiles[a]=null;var t=g.selectedFiles.filter(function(e){return null!=e});t&&0!=t.length||(g.selectedFiles=[],e._vm.selectedFiles=[])}for(var r=0;r<g.selectedFiles.length;r++){a(g.selectedFiles[r],r)}},T.prototype.getKQ3DServerWorkspaceNames=function(e){if(e){var a=this;new o.KQGIS3DServerRequest({url:e}).getServiceInfo().then(function(e){var t=e.workspaces;a._vm.$set(a._vm.urlParams,"workspaceNameList",t)},function(e){console.log(e.errorText)})}},T.prototype.getKQ3DServerDatasetNames=function(e,a,t){if(t=t||"raster",e&&o.defined(a)){var r=this;new o.KQGIS3DServerRequest({url:e}).getWorkspaceInfo(a).then(function(e){var a=[];e.datasets.forEach(function(e){e.type==t&&a.push(e)}),r._vm.$set(r._vm.urlParams,"datasetNameList",a)},function(e){console.log(e.errorText)})}else alert("The url or dataset name is incorrect")},T.prototype.getKQ3DServerDataclassNames=function(e,a,t){if(t=t||"raster",e&&o.defined(a)){var r=this;new o.KQGIS3DServerRequest({url:e}).getDatasetInfo(a).then(function(e){var a=[];e.dataclasses.forEach(function(e){e.type==t&&a.push(e)}),r._vm.$set(r._vm.urlParams,"dataclassNameList",a)},function(e){console.log(e.errorText)})}else alert("The url or dataset name is incorrect")},T.prototype.getOGCServerLayerList=function(e,a){if(a){var t=this;e==m.eDataSourceType.WebMapTileServiceImagery?y.parseOGCWMTSCapabilities(a).then(function(e){t._vm.$set(t._vm.urlParams,"ogcLayerNameList",e)},function(){t._vm.$set(t._vm.urlParams,"ogcLayerNameList",[])}):e==m.eDataSourceType.WebMapServiceImagery&&y.parseOGCWMSCapabilities(a).then(function(e){t._vm.$set(t._vm.urlParams,"ogcLayerNameList",e)},function(){t._vm.$set(t._vm.urlParams,"ogcLayerNameList",[])})}else alert("The url is incorrect")},T.prototype.loadURLDataToScene=function(){switch(this._vm.urlParams.type){case m.eDataSourceType.KQGIS3DServerImagery:if(-1==(a=this._vm.urlParams.datasetId))return void alert("Not found correct imagery data.");var e={name:this._vm.urlParams.workspaceName+"-"+this._vm.urlParams.datasetName,url:this._vm.urlParams.url,type:m.eObjectType.Imagery,dataSourceType:m.eDataSourceType.KQGIS3DServerImagery,enablePickFeatures:!1,rasterDatasetId:a,credit:"KQGIS 3D Server(Imagery)."};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.KQGIS3DTileFileImagery:e={name:this._vm.urlParams.name||v.unKnownImagery,url:this._vm.urlParams.url,type:m.eObjectType.Imagery,dataSourceType:m.eDataSourceType.KQGIS3DTileFileImagery,enablePickFeatures:!1,credit:"KQGIS 3D Tile File(Imagery)."};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.KQGIS3DServerTerrain:var a;if(-1==(a=this._vm.urlParams.datasetId))return void alert("Not found correct terrain data.");e={name:this._vm.urlParams.workspaceName+"-"+this._vm.urlParams.datasetName,url:this._vm.urlParams.url,type:m.eObjectType.Terrain,dataSourceType:m.eDataSourceType.KQGIS3DServerTerrain,rasterDatasetId:a,credit:"KQGIS 3D Server(Terrain)."};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.KQGIS3DTileFileTerrain:e={name:this._vm.urlParams.name||v.unKnownLayer,url:this._vm.urlParams.url,type:m.eObjectType.Terrain,dataSourceType:m.eDataSourceType.KQGIS3DTileFileTerrain,credit:"KQGIS 3D Tile File(Terrain)."};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.CesiumTerrain:var t=this._vm.urlParams.url,r=t.substring(t.lastIndexOf(".")+1);r&&"json"==r.toLowerCase()&&(t=t.substring(0,t.lastIndexOf("/")));e={name:this._vm.urlParams.name||v.unKnownLayer,url:t,type:m.eObjectType.Terrain,dataSourceType:m.eDataSourceType.CesiumTerrain,credit:"STK Terrain."};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.Cesium3DTileset:e={name:(this._vm.urlParams.isKq3dServer?this._vm.urlParams.dataclassName:this._vm.urlParams.name)||v.unKnownLayer,url:this._vm.urlParams.url,type:m.eObjectType.Cesium3DTileset,dataSourceType:m.eDataSourceType.Cesium3DTileset,shadows:0,enablePickFeatures:!0,isKq3dServer:this._vm.urlParams.isKq3dServer,dataclassId:this._vm.urlParams.dataclassId};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.ArcGISMapServerImagery:e={name:this._vm.urlParams.name||v.unKnownLayer,url:this._vm.urlParams.url,type:m.eObjectType.Imagery,dataSourceType:m.eDataSourceType.ArcGISMapServerImagery,credit:"ArcGIS MapServer."};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.KQGISMapServerImagery:e={name:this._vm.urlParams.name||v.unKnownLayer,url:this._vm.urlParams.url,type:m.eObjectType.Imagery,queryLayerId:-1,dataSourceType:m.eDataSourceType.KQGISMapServerImagery,credit:"KQGIS MapServer."};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.WebMapServiceImagery:if(-1==this._vm.urlParams.ogcLayerNameId)return void alert("Please select layer.");var i=void 0,s=void 0,n=(y=this._vm.urlParams.ogcLayerNameList[this._vm.urlParams.ogcLayerNameId]).boundingBox;if("epsg:4326"==n.srs.toLowerCase())i=new o.GeographicTilingScheme,s=new o.Rectangle,o.Rectangle.fromDegrees(Number(n.minx),Number(n.miny),Number(n.maxx),Number(n.maxy),s);else{i=new WebMercatorTilingScheme;var c=new o.WebMercatorProjection,l=new o.Cartesian3(Number(n.maxx),Number(n.maxy)),d=new o.Cartographic;c.unproject(l,d);l=new o.Cartesian3(Number(n.minx),Number(n.miny));var u=new o.Cartographic;c.unproject(l,u),s=new o.Rectangle(u.longitude,u.latitude,d.longitude,d.latitude)}e={name:this._vm.urlParams.name||v.unKnownLayer,url:this._vm.urlParams.url,type:m.eObjectType.Imagery,dataSourceType:m.eDataSourceType.WebMapServiceImagery,layers:y.name,tilingScheme:i,rectangle:s,parameters:{format:y.format},credit:"OGC WMS."};this.addSceneLayerByOptions(e);break;case m.eDataSourceType.WebMapTileServiceImagery:if(-1==this._vm.urlParams.ogcLayerNameId)return void alert("Please select layer.");var y;i=void 0;"c"==(y=this._vm.urlParams.ogcLayerNameList[this._vm.urlParams.ogcLayerNameId]).tileMatrixSetID&&(i=new o.GeographicTilingScheme);c=new o.WebMercatorProjection,s=void 0;var p=y.boundingBox.upperCorner,S=y.boundingBox.lowerCorner;if(p&&S)if("c"!==y.tileMatrixSetID){l=new o.Cartesian3(Number(p[0]),Number(p[1])),d=new o.Cartographic;c.unproject(l,d);l=new o.Cartesian3(Number(S[0]),Number(S[1])),u=new o.Cartographic;c.unproject(l,u),s=new o.Rectangle(u.longitude,u.latitude,d.longitude,d.latitude)}else s=new o.Rectangle,o.Rectangle.fromDegrees(Number(S[0]),Number(S[1]),Number(p[0]),Number(p[1]),s);e={name:this._vm.urlParams.ogcLayerName||v.unKnownLayer,url:this._vm.urlParams.url,type:m.eObjectType.Imagery,layer:y.name,style:y.style,tileMatrixSetID:y.tileMatrixSetID,tilingScheme:i,rectangle:s,tileMatrixLabels:y.tileMatrixLabels,format:y.format,dataSourceType:m.eDataSourceType.WebMapTileServiceImagery,credit:"OGC WMTS."};this.addSceneLayerByOptions(e)}},i(T.prototype,{container:{get:function(){return this._container}},vm:{get:function(){return this._vm}},shown:{get:function(){return this._container.shown},set:function(e){this._container.shown=e}}}),T.prototype.addSceneLayerByOptions=function(e,a){switch(e.type){case m.eObjectType.Imagery:this.addImageryLayerByOptions(e,a);break;case m.eObjectType.Terrain:this.addTerrianLayerByOptions(e,a);break;case m.eObjectType.DataSource:this.addDataSourceLayerByOptions(e,a);break;case m.eObjectType.Cesium3DTileset:this.addCesium3DTilesetByOptions(e,a)}},T.prototype.addImageryLayerByOptions=function(e,a){e=o.defaultValue(e,{});var t=this,r=t.getDataSourceByOptions(e),i=null;if(r.object){var s=!o.defined(e.show)||e.show;i=new o.ImageryLayer(r.object,{show:s,name:e.name})}i?(t._viewer.imageryLayers.add(i),a&&i.getViewableRectangle().then(function(e){return t._viewer.camera.flyTo({destination:e})})):alert("Not found correct imagery data.")},T.prototype.addTerrianLayerByOptions=function(e,a){e=o.defaultValue(e,{});var t=this.getDataSourceByOptions(e).object;t?this._viewer.terrainProvider=t:alert("Not found correct terrain data.")},T.prototype.addCesium3DTilesetByOptions=function(e,a){var t=this,r=t.getDataSourceByOptions(e),i=null;r.object?(i=t._viewer.scene.primitives.add(r.object)).readyPromise.then(function(){if(a){var r=i.boundingSphere;t._viewer.camera.flyToBoundingSphere(r,{duration:1.5})}e.style&&(i.style=new o.Cesium3DTileStyle(e.style)),e.enablePickFeatures&&b(t._viewer);var s=Number(t.vm.urlParams.heightOffset),n=(r=i.boundingSphere,o.Cartographic.fromCartesian(r.center)),c=o.Cartesian3.fromRadians(n.longitude,n.latitude,0),l=o.Cartesian3.fromRadians(n.longitude,n.latitude,s),d=o.Cartesian3.subtract(l,c,new o.Cartesian3);i.modelMatrix=o.Matrix4.fromTranslation(d)}).otherwise(function(e){console.log("Not found correct 3dTiles data.")}):console.log("Not found correct 3dTiles data.")},T.prototype.addDataSourceLayerByOptions=function(e,a){var t=this,r=t.getDataSourceByOptions(e),i=null;r.object&&(i=r.object,t._viewer.dataSources.add(i).then(function(r){var i=o.defaultValue(e.show,!0);r.show=i,a&&t._viewer.flyTo(r.entities,{duration:1.5}),e.selected=!0,e.guid=r.guid}).otherwise(function(e){}))},T});