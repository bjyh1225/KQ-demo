define(["text!views/html/LayerList.html","libs/common/common","libs/common/defined","libs/common/defaultValue","libs/common/defineProperties","jquery","Vue","zTreeCheck","zTreeEdit","Bootstrap","views/Container","Cesium","views/ImagerLayerAdjust"],function(e,t,i,n,r,a,o,d,s,c,l,h,u){var m="root",v="imageryLayers",g="imageryLayer",p="primitives",f="primitive",y="dataSources",w="dataSource",b="cesiumObjects",_="cesiumObject",T="terrains",N="terrain",k={RootNode:{id:t.newGuid(),name:window.platformLanguage&&window.platformLanguage.layerList?window.platformLanguage.layerList:"图层列表",type:m,nocheck:!0,children:[]},ImageLayerNode:{id:t.newGuid(),name:window.platformLanguage&&window.platformLanguage.imageLayers?window.platformLanguage.imageLayers:"影像图层",type:v,open:!0,nocheck:!0,checked:!0},PrimitiveNode:{id:t.newGuid(),name:window.platformLanguage&&window.platformLanguage.primitives?window.platformLanguage.primitives:"Primitives",type:p,open:!0,checked:!0},DataSourceNode:{id:t.newGuid(),name:window.platformLanguage&&window.platformLanguage.dataSources?window.platformLanguage.dataSources:"DataSources",type:y,open:!0,checked:!0},DrawnObjectNode:{id:t.newGuid(),name:window.platformLanguage&&window.platformLanguage.drawnObjects?window.platformLanguage.drawnObjects:"My Drawn Object",type:b,open:!0,checked:!0},PanoObjectNode:{id:t.newGuid(),name:window.platformLanguage&&window.platformLanguage.panoObjects?window.platformLanguage.panoObjects:"全景图",type:b,open:!0,checked:!0},TerrainNode:{id:t.newGuid(),name:window.platformLanguage&&window.platformLanguage.terrains?window.platformLanguage.terrains:"地形数据集",type:T,open:!0,checked:!0}},L={check:{enable:!0},data:{simpleData:{enable:!0}},edit:{enable:!1,showRemoveBtn:!0,showRenameBtn:!1,removeTitle:"Remove"},view:{showIcon:!1,showLine:!0},callback:{}},C={layerList:"图层列表",inputKeyword:"输入关键词...",search:"搜索",raiseToTop:"移至顶层",raise:"上移一层",lower:"下移一层",lowerToBottom:"移至底层",remove:"移除",properties:"属性"};for(var O in C)C[O]=platformLanguage[O]?platformLanguage[O]:C[O];function P(i){this._id=t.newGuid(),this._viewer=n(i.viewer,null),this._parentContainer=n(i.parentContainer,"cesiumContainer"),"string"==typeof this._parentContainer&&(this._parentContainer=a("#"+this._parentContainer)),this._parentContainer instanceof HTMLElement&&(this._parentContainer=a(this._parentContainer)),this._title=n(i.title,C.layerList),this._content=n(e,""),this._containerCollection={},this._shown=n(i.shown,!0),this._showHeader=n(i.showHeader,!0),this._showTitle=n(i.showTitle,!0),this._showCloseBtn=n(i.showCloseBtn,!0),this._style=n(i.style,{position:"absolute",top:"0",left:"0",margin:"0",width:"auto"}),this._style.zIndex=999,this._bodyStyle=n(i.bodyStyle,{margin:0,paddingTop:"5px",paddingBottom:"5px",paddingLeft:"5px",paddingRight:"5px",height:"calc(100% - 28px)"}),this.zTreeSettings=L,this._container=null,this._vm=null,this._id=t.newGuid(),this.initialize(i)}Object.defineProperty(h.ImageryLayer,"show",function(){}),P.prototype.initialize=function(){var e={parentContainer:this._parentContainer,title:this._title,content:this._content,shown:this._shown,showHeader:this._showHeader,showTitle:this._showTitle,showCloseBtn:this._showCloseBtn,style:this._style,bodyStyle:this._bodyStyle};this._container=new l(e);var t=this;this._vm=new o({el:".module-layer-list-content",data:{guid:t._id,titles:C,keyword:""},methods:{searchTree:function(){alert(this.keyword)},treeNodeMenuItemClick:function(e){t.treeNodeMenuItemClick(e)}},created:function(){}}),this.render()},P.prototype.render=function(){var e=this;e.zTreeSettings.callback.onCheck=function(t,i,n){e.onCheck(t,i,n)},e.zTreeSettings.callback.onRightClick=function(t,i,n){e.onRightClick(t,i,n)},e.zTreeSettings.callback.onDblClick=function(t,i,n){e.onDblClick(t,i,n)},e.zTreeSettings.callback.onRemove=function(t,i,n){e.onRemove(t,i,n)},a.fn.zTree.init(a("#layerManagerTree_"+e._id),e.zTreeSettings,[]),e.listenSceneObjectEvent()},P.prototype.closeContainersException=function(e){for(var t in"string"==typeof e&&(e=[e]),!e instanceof Array&&(e=[]),this._containerCollection)a.inArray(t,e)<0&&(this._containerCollection[t].shown=!1)},P.prototype.listenSceneObjectEvent=function(){var e=this,t=this._viewer.imageryLayers;function i(e,t){var i=t.show,n=e.indexOf(t);if(1==i){var r=[],a=e.length;if(a>5){for(var o=0;o<a;o++){e.get(o).show&&r.push(o)}if(r.length>5){var d=r.indexOf(n);r.length-d>d?e.get(r[r.length-1]).show=!1:e.get(r[0]).show=!1}}}}t.layerAdded.addEventListener(function(n){e.listenOnAddImageryLayer(n),i(t,n)},{}),t.layerMoved.addEventListener(function(e,t,i){},{}),t.layerRemoved.addEventListener(function(t){e.listenOnRemoveImageryLayer(t)},{}),t.layerShownOrHidden.addEventListener(function(n,r,o){i(t,n);var d=a.fn.zTree.getZTreeObj("layerManagerTree_"+e._id),s=n.guid,c=d.getNodeByParam("id",s);c&&d.checkNode(c,o,!1)},{});var n=this._viewer.scene.primitives;n.primitiveAdded.addEventListener(function(t){t.readyPromise?t.readyPromise.then(function(){e.listenOnAddPrimitive(t)}):e.listenOnAddPrimitive(t)},{}),n.primitiveMoved.addEventListener(function(e,t,i){},{}),n.primitiveRemoved.addEventListener(function(t){e.listenOnRemovePrimitive(t)},{});var r=this._viewer.dataSources;r.dataSourceAdded.addEventListener(function(t,i){setTimeout(function(){e.listenOnAddDataSource(t,i)},50)},{}),r.dataSourceRemoved.addEventListener(function(t,i){e.listenOnRemoveDataSource(t,i)},{});var o=this._viewer.objectManager;o.addedEvent.addEventListener(function(t){e.listenOnAddCesiumObject(t)},{}),o.removedEvent.addEventListener(function(t){e.listenOnRemoveCesiumObject(t)},{})},P.prototype.showRemoveBtn=function(e,t){var i=t.type||void 0;return i==g||i==f||i==w||i==_},P.prototype.onAddHoverDom=function(e,t){t.type},P.prototype.onCheck=function(e,t,i){if(i){var n=i.type||void 0,r=i.id,a=this._viewer.imageryLayers,o=this._viewer.scene.primitives,d=this._viewer.dataSources,s=this._viewer.objectManager;switch(n){case v:for(var c=i.children&&i.children||[],l=0;l<c.length;l++){a.getLayerByGuid(c[l].id).show=i.checked}break;case g:a.getLayerByGuid(r).show=i.checked;break;case p:for(c=i.children&&i.children||[],l=0;l<c.length;l++){o.getPrimitiveByGuid(c[l].id).show=i.checked}break;case f:o.getPrimitiveByGuid(r).show=i.checked;break;case y:for(c=i.children&&i.children||[],l=0;l<c.length;l++){d.getDataSourceByGuid(c[l].id).show=i.checked}break;case w:d.getDataSourceByGuid(r).show=i.checked;break;case b:for(c=i.children&&i.children||[],l=0;l<c.length;l++){(u=s.getCesiumObject(c[l].id)).show=i.checked}break;case _:var u;(u=s.getCesiumObject(r))&&(u.show=i.checked);break;case N:var m=j[r];m&&(i.checked?this._viewer.terrainProvider=m:this._viewer.terrainProvider=new h.EllipsoidTerrainProvider({}))}}},P.prototype.onDblClick=function(e,t,i){if(i){var n=this,r=i.type||void 0,a=i.id,o=this._viewer.imageryLayers,d=this._viewer.scene.primitives,s=this._viewer.dataSources,c=this._viewer.objectManager;switch(r){case g:o.getLayerByGuid(a).getViewableRectangle().then(function(e){return n._viewer.camera.flyTo({destination:e})});break;case f:var l=d.getPrimitiveByGuid(a);if(l instanceof h.Cesium3DTileset){var u=l.boundingSphere;this._viewer.camera.flyToBoundingSphere(u,{duration:1.5})}break;case w:var m=s.getDataSourceByGuid(a);m&&n._viewer.flyTo(m.entities,{duration:1.5});break;case _:var v=c.getCesiumObject(a);v&&v.location();break;case N:var p=j[a];if(p){if((p instanceof h.KQGIS3DServerTerrainProvider||p instanceof h.KQGIS3DTileFileTerrainProvider)&&p.ExtentSource){var y=h.Rectangle.fromDegrees(p.ExtentSource.left,p.ExtentSource.bottom,p.ExtentSource.right,p.ExtentSource.top);n._viewer.scene.camera.flyTo({destination:y})}if(p instanceof h.CesiumTerrainProvider&&p.bounds){y=h.Rectangle.fromDegrees.apply(null,p.bounds);n._viewer.scene.camera.flyTo({destination:y})}}}}},P.prototype.onRightClick=function(e,t,i){if(e.preventDefault(),i){var n=a.fn.zTree.getZTreeObj(t);n.selectNode(i,!1);var r=i.type||void 0,o=new S("node_context_menu_"+this._id),d=a("#node_context_menu_"+this._id).parent().offset(),s={top:e.pageY-d.top,left:e.pageX-d.left},c=n.getNodeIndex(i),l=i.getParentNode(),h=l?l.children:[];switch(0==h.length?o.menu("disableItems",[0,1,2,3]):(o.menu("enableItems",[0,1,2,3]),0==c&&o.menu("disableItems",[0,1]),c==h.length-1&&o.menu("disableItems",[2,3])),r){case g:case f:case w:case N:case _:o.menu("show",s)}}},P.prototype.onRemove=function(e,t,i){if(i){var n=i.type||void 0,r=i.id,o=this._viewer.imageryLayers,d=this._viewer.scene.primitives,s=this._viewer.dataSources,c=this._viewer.objectManager;switch(n){case g:var l=o.getLayerByGuid(r);l&&o.remove(l);break;case f:var h=d.getPrimitiveByGuid(r);h&&d.remove(h);break;case w:var u=s.getDataSourceByGuid(r);u&&s.remove(u);case _:var m=c.getCesiumObject(r);m&&c.removeCesiumObject(m)}var v=i.getParentNode();if(v&&(!v.children||0==v.children.length))a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id).removeNode(v)}},P.prototype.listenOnAddImageryLayer=function(e){var t=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),i=e.guid,n=e.show,r={id:i,name:e._name?e._name:e._imageryProvider._name&&e._imageryProvider._name||i,type:g,checked:n},o=t.getNodeByParam("id",k.ImageLayerNode.id);if(!o){o=t.addNodes(null,k.ImageLayerNode)[0]}var d=t.addNodes(o,r);d&&d.length>0&&(o=d[0].getParentNode(),t.moveNode(o.children[0],d[0],"prev"))},P.prototype.listenOnRemoveImageryLayer=function(e){var t=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),i=e.guid,n=t.getNodeByParam("id",i);if(n){t.removeNode(n);var r=n.getParentNode();!r||r.children&&0!=r.children.length||t.removeNode(r)}},P.prototype.openImagerLayerAdjust=function(e,t){var i={viewer:this._viewer,imageryLayer:e};this.closeContainersException("ImagerLayerAdjust"),this._containerCollection.ImagerLayerAdjust||t!=g?t==g&&(this._containerCollection.ImagerLayerAdjust.update(e),this._containerCollection.ImagerLayerAdjust.shown=!0):this._containerCollection.ImagerLayerAdjust=new u(i)},P.prototype.listenOnAddPrimitive=function(e){if(e instanceof h.Cesium3DTileset){var t=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),i=e.guid,n=e.show,r={id:i,name:e.name&&e.name||i,type:f,checked:n},o=t.getNodeByParam("id",k.PrimitiveNode.id);if(!o){o=t.addNodes(null,k.PrimitiveNode)[0]}var d=t.addNodes(o,r);d&&d.length>0&&(o=d[0].getParentNode(),t.moveNode(o.children[0],d[0],"prev")),cesiumContainerVue.tilesData.push({id:e.guid,name:e.name&&e.name||e.guid})}},P.prototype.listenOnRemovePrimitive=function(e){var t=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),i=e.guid,n=t.getNodeByParam("id",i);if(n){t.removeNode(n);var r=n.getParentNode();!r||r.children&&0!=r.children.length||t.removeNode(r)}cesiumContainerVue.tilesData.forEach((e,t)=>{i===e.id&&(cesiumContainerVue.tilesData.splice(t,1),i===cesiumContainerVue.curBoxClipPrimitiveId&&(cesiumContainerVue.curBoxClip.enable=!1,cesiumContainerVue.curBoxClip=null))})},P.prototype.listenOnAddDataSource=function(e,t){var i=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),n=t.guid,r=t.show,o={id:n,name:t.name&&t.name||n,type:w,checked:r},d=i.getNodeByParam("id",k.DataSourceNode.id);if(!d){d=i.addNodes(null,k.DataSourceNode)[0]}var s=i.addNodes(d,o);s&&s.length>0&&(d=s[0].getParentNode(),i.moveNode(d.children[0],s[0],"prev"))},P.prototype.listenOnRemoveDataSource=function(e,t){var i=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),n=t.guid,r=i.getNodeByParam("id",n);if(r){i.removeNode(r);var o=r.getParentNode();!o||o.children&&0!=o.children.length||i.removeNode(o)}},P.prototype.listenOnAddCesiumObject=function(e){var t=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),i=e.guid,n=e.show,r={id:i,name:e.name&&e.name||i,type:_,checked:n},o=null;o="pano"==e.nodeType?k.PanoObjectNode:k.DrawnObjectNode;var d=t.getNodeByParam("id",o.id);if(!d){d=t.addNodes(null,o)[0]}var s=t.addNodes(d,r);s&&s.length>0&&(d=s[0].getParentNode(),t.moveNode(d.children[0],s[0],"prev"))},P.prototype.listenOnRemoveCesiumObject=function(e){var t=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),i=e.guid,n=t.getNodeByParam("id",i);if(n){t.removeNode(n);var r=n.getParentNode();!r||r.children&&0!=r.children.length||t.removeNode(r)}};var j=[];function S(e){var t=a("#"+e);function i(){t.hide(300)}this.$el=t,this.removeItems=function(t){null==t&&(t=[]),t instanceof Array||(t=[t]),t.forEach(function(t){a("#"+e+" li:eq("+t+")").remove()})},function(){var e=t.css("backgroundColor").toLowerCase();if(e.indexOf("rgba")>-1){var i=e.replace(/ /g,"").replace("rgba(","").replace(")","").split(",");i[3]=1,t.css("backgroundColor","rgba("+i.join(",")+")")}}(),this.menu=function(n,r){switch(n){case"enableItems":null==(c=r)&&(c=[]),c instanceof Array||(c=[c]),c.forEach(function(t){a("#"+e+" li:eq("+t+")").removeClass("disabled"),a("#"+e+" li:eq("+t+")").attr("disabled",!1),a("#"+e+" li:eq("+t+") a").attr("disabled",!1)});break;case"disableItems":!function(t){null==t&&(t=[]),t instanceof Array||(t=[t]),t.forEach(function(t){a("#"+e+" li:eq("+t+")").addClass("disabled"),a("#"+e+" li:eq("+t+")").attr("disabled",!0),a("#"+e+" li:eq("+t+") a").attr("disabled",!0)})}(r);break;case"removeItems":!function(t){null==t&&(t=[]),t instanceof Array||(t=[t]),t.forEach(function(t){a("#"+e+" li:eq("+t+")").remove()})}(r);break;case"addItem":s=r,t.append(s);break;case"show":o=r.left||0,d=r.top||0,t.show(),t.css("top",d+"px").css("left",o+"px"),t.unbind("mouseleave",i).bind("mouseleave",i),a("#"+e+" li").unbind("click",i).bind("click",i);break;case"hide":i()}var o,d,s,c}}return P.prototype.listenOnAddTerrain=function(e,i){if(e instanceof h.KQGIS3DServerTerrainProvider||e instanceof h.CesiumTerrainProvider||e instanceof h.KQGIS3DTileFileTerrainProvider){var n=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),r=t.newGuid(),o={id:r,name:i,type:N,checked:!0},d=n.getNodeByParam("id",k.TerrainNode.id);if(!d){d=n.addNodes(null,k.TerrainNode)[0],j.push(r),j[r]=e}var s=n.addNodes(d,o);s&&s.length>0&&(d=s[0].getParentNode(),n.moveNode(d.children[0],s[0],"prev"))}},P.prototype.listenOnRemoveTerrain=function(e){var t=a.fn.zTree.getZTreeObj("layerManagerTree_"+this._id),i=t.getNodeByParam("id",e);if(i){t.removeNode(i);var n=i.getParentNode();!n||n.children&&0!=n.children.length||t.removeNode(n)}j[e]&&(this._viewer.terrainProvider=new h.EllipsoidTerrainProvider({}))},P.prototype.treeNodeMenuItemClick=function(e){var t={},i="layerManagerTree_"+this._id,n=a.fn.zTree.getZTreeObj(i),r=n.getSelectedNodes();if(r&&r.length>0){t=r[0];this._viewer.imageryLayers;var o=void 0,d=void 0,s=-1,c=0,l=t.type||void 0;switch(l){case g:d=(o=this._viewer.imageryLayers).getLayerByGuid(t.id),s=o.indexOf(d),c=o.length;break;case f:d=(o=this._viewer.scene.primitives).getPrimitiveByGuid(t.id),s=o._primitives.indexOf(d),c=o.length;break;case w:d=(o=this._viewer.dataSources).getDataSourceByGuid(t.id),s=o.indexOf(d),c=o.length;break;case _:d=(o=this._viewer.objectManager).getCesiumObject(t.id),s=o.indexOf(d),c=o.length}if(l===N)switch(e){case"remove":this.listenOnRemoveTerrain(t.id)}if(o&&d)switch(e){case"up":s<c-1&&("function"==typeof o.raise&&o.raise(d),h(t,"up"));break;case"top":s<c-1&&("function"==typeof o.raiseToTop&&o.raiseToTop(d),h(t,"top"));break;case"down":s>0&&("function"==typeof o.lower&&o.lower(d),h(t,"down"));break;case"bottom":s>0&&("function"==typeof o.lowerToBottom&&o.lowerToBottom(d),h(t,"bottom"));break;case"remove":o.remove(d);break;case"attribute":this.openImagerLayerAdjust(d,l)}}function h(e,t){var i=e.getParentNode().children;switch(t){case"up":n.moveNode(e.getPreNode(),e,"prev");break;case"down":n.moveNode(e.getNextNode(),e,"next");break;case"top":n.moveNode(i[0],e,"prev");break;case"bottom":n.moveNode(i[i.length-1],e,"next")}}},r(P.prototype,{container:{get:function(){return this._container}},vm:{get:function(){return this._vm}},shown:{get:function(){return this._container.shown},set:function(e){this._container.shown=e}},viewer:{get:function(){return this._viewer}}}),P});