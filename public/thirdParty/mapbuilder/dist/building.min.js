!function(e){"use strict";var t=Math,r=t.exp,a=t.log,d=t.sin,u=t.cos,g=t.tan,o=t.atan,y=t.atan2,s=t.min,m=t.max,x=t.sqrt,f=t.ceil,l=(t.floor,t.round,t.pow),n=n||Array,w=w||Array,i=/iP(ad|hone|od)/g.test(navigator.userAgent),h=!!~navigator.userAgent.indexOf("Trident"),c=!e.requestAnimationFrame||i||h?function(e){e()}:e.requestAnimationFrame,p=function(){var i={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};function n(e,t,i){return i<0&&(i+=1),1<i&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}function a(e,t){if(void 0!==e)return Math.min(t,Math.max(0,e||0))}var s=function(e,t,i,r){this.r=a(e,1),this.g=a(t,1),this.b=a(i,1),this.a=a(r,1)||1,this.isValid=void 0!==this.r&&void 0!==this.g&&void 0!==this.b};return s.parse=function(e){if("string"==typeof e){var t;if(e=e.toLowerCase(),t=(e=i[e]||e).match(/^#?(\w{2})(\w{2})(\w{2})$/))return new s(parseInt(t[1],16)/255,parseInt(t[2],16)/255,parseInt(t[3],16)/255);if(t=e.match(/^#?(\w)(\w)(\w)$/))return new s(parseInt(t[1]+t[1],16)/255,parseInt(t[2]+t[2],16)/255,parseInt(t[3]+t[3],16)/255);if(t=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new s(parseFloat(t[1])/255,parseFloat(t[2])/255,parseFloat(t[3])/255,t[4]?parseFloat(t[5]):1)}return new s},s.fromHSL=function(e,t,i,r){if(0===t)return new s(i,i,i,r);var a=i<.5?i*(1+t):i+t-i*t,o=2*i-a;return new s(n(o,a,(e/=360)+1/3),n(o,a,e),n(o,a,e-1/3),r)},s.prototype={toHSL:function(){if(this.isValid){var e,t,i=Math.max(this.r,this.g,this.b),r=Math.min(this.r,this.g,this.b),a=(i+r)/2,o=i-r;if(o){switch(t=.5<a?o/(2-i-r):o/(i+r),i){case this.r:e=(this.g-this.b)/o+(this.g<this.b?6:0);break;case this.g:e=(this.b-this.r)/o+2;break;case this.b:e=(this.r-this.g)/o+4}e*=60}else e=t=0;return{h:e,s:t,l:a,a:this.a}}},toString:function(){if(this.isValid)return 1===this.a?"#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1,7):"rgba("+[Math.round(255*this.r),Math.round(255*this.g),Math.round(255*this.b),this.a.toFixed(2)].join(",")+")"},toArray:function(){if(this.isValid)return[this.r,this.g,this.b]},hue:function(e){var t=this.toHSL();return s.fromHSL(t.h+e,t.s,t.l)},saturation:function(e){var t=this.toHSL();return s.fromHSL(t.h,t.s*e,t.l)},lightness:function(e){var t=this.toHSL();return s.fromHSL(t.h,t.s,t.l*e)},red:function(e){return new s(this.r*e,this.g,this.b,this.a)},green:function(e){return new s(this.r,this.g*e,this.b,this.a)},blue:function(e){return new s(this.r,this.g,this.b*e,this.a)},alpha:function(e){return new s(this.r,this.g,this.b,this.a*e)},copy:function(){return new s(this.r,this.g,this.b,this.a)}},s}();"object"==typeof module&&(module.exports=p);var v,b,_,k,S,C,H=function(){var e=Math,k=e.PI,S=e.sin,C=e.cos,H=e.tan,M=e.asin,P=e.atan2,T=k/180,t=864e5,i=2440588,I=23.4397*T;function j(e){return e.valueOf()/t-.5+i-2451545}return function(e,t,i){var r,a,o,n,s,l,h,f,c,d,u,g=T*-i,p=T*t,y=j(e),m=T*(357.5291+.98560028*y),x=T*(1.9148*S(s=m)+.02*S(2*s)+3e-4*S(3*s)),v=m+x+102.9372*T+k,b=(o=v,M(S(n=0)*C(I)+C(n)*S(I)*S(o))),w=(a=0,P(S(r=v)*C(I)-H(a)*S(I),C(r))),_=T*(280.16+360.9856235*y)-g-w;return{altitude:(c=_,d=p,u=b,M(S(d)*S(u)+C(d)*C(u)*C(c))),azimuth:(l=_,h=p,f=b,P(S(l),C(l)*S(h)-H(f)*C(h))-k/2)}}}(),M=function(){var a=3,t={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},i={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};function o(e){return"#"===(e=e.toLowerCase())[0]?e:t[i[e]||e]||null}var c="CW",d="CCW";function u(e,t){if(function(e){var t,i,r,a,o,n=0;for(a=0,o=e.length-3;a<o;a+=2)t=e[a],i=e[a+1],r=e[a+2],n+=t*e[a+3]-r*i;return 0<n/2?c:d}(e)===t)return e;for(var i=[],r=e.length-2;0<=r;r-=2)i.push(e[r],e[r+1]);return i}function g(e){var t={};e=e||{},t.height=e.buildingHeight||(e.levels?e.levels*a:$),t.minHeight=e.minHeight||(e.minLevel?e.minLevel*a:0);var i=e.material?o(e.material):e.wallColor||e.color;i&&(t.wallColor=i);var r=e.roofMaterial?o(e.roofMaterial):e.roofColor;switch(r&&(t.roofColor=r),e.shape){case"cylinder":case"cone":case"dome":case"sphere":t.shape=e.shape,t.isRotational=!0;break;case"pyramid":t.shape=e.shape}switch(e.roofShape){case"cone":case"dome":t.roofShape=e.roofShape,t.isRotational=!0;break;case"pyramid":t.roofShape=e.roofShape}return t.roofShape&&e.roofHeight?(t.roofHeight=e.roofHeight,t.height=m(0,t.height-t.roofHeight)):t.roofHeight=0,t}function p(e){var t,i,r,a,o=[];switch(e.type){case"GeometryCollection":for(o=[],t=0,i=e.geometries.length;t<i;t++)(a=p(e.geometries[t]))&&o.push.apply(o,a);return o;case"MultiPolygon":for(o=[],t=0,i=e.coordinates.length;t<i;t++)(a=p({type:"Polygon",coordinates:e.coordinates[t]}))&&o.push.apply(o,a);return o;case"Polygon":r=e.coordinates;break;default:return[]}var n,s,l,h=[],f=[];for(i=(l=r[t=0]).length;t<i;t++)h.push(l[t][1],l[t][0]);for(h=u(h,c),t=0,i=r.length-1;t<i;t++){for(l=r[t+1],f[t]=[],n=0,s=l.length;n<s;n++)f[t].push(l[n][1],l[n][0]);f[t]=u(f[t],d)}return[{outer:h,inner:f.length?f:null}]}function y(e){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}return{read:function(e){if(!e||"FeatureCollection"!==e.type)return[];var t,i,r,a,o,n,s,l,h=e.features,f=[];for(t=0,i=h.length;t<i;t++)if("Feature"===(o=h[t]).type&&!1!==Se(o))for(s=g(o.properties),r=0,a=(n=p(o.geometry)).length;r<a;r++)(l=y(s)).footprint=n[r].outer,l.isRotational&&(l.radius=ee(l.footprint)),n[r].inner&&(l.holes=n[r].inner),(o._building_id||o.properties.id)&&(l.id=o._building_id||o.properties.id),o.properties.relationId&&(l.relationId=o.properties.relationId),f.push(l);return f}}}(),P='&copy; <a href="https://osmbuildings.org">OSM Buildings</a>',T=Math.PI,I=T/2,j=T/4,z=256,A=15,D="latitude",R="longitude",O=0,E=0,Z=0,F=0,q=0,N=0,V=p.parse("rgba(200, 190, 180)"),B=V.lightness(.8),J=V.lightness(1.2),W=""+V,X=""+B,G=""+J,U=0,Y=1,$=5,K=450;function Q(e,t){var i=e.x-t.x,r=e.y-t.y;return i*i+r*r}function ee(e){for(var t=180,i=-180,r=0,a=e.length;r<a;r+=2)t=s(t,e[r+1]),i=m(i,e[r+1]);return(i-t)/2}function te(e,t){var i={};return e/=b,t/=b,i[D]=t<=0?90:1<=t?-90:(2*o(r(T*(1-2*t)))-I)/T*180,i[R]=360*(1===e?1:(e%1+1)%1)-180,i}function ie(e,t){var i=s(1,m(0,.5-a(g(j+I*e/180))/T/2));return{x:(t/360+.5)*b<<0,y:i*b<<0}}function re(e){for(var t=O+q,i=E+N,r=0,a=e.length-3;r<a;r+=2)if(e[r]>q&&e[r]<t&&e[r+1]>N&&e[r+1]<i)return!0;return!1}var ae,oe,ne,se,le=(ae={},oe=[],ne=0,{loadJSON:function(e,i){return function(i,r){if(!ae[i]){var a=new XMLHttpRequest;return a.onreadystatechange=function(){if(4===a.readyState&&!(!a.status||a.status<200||299<a.status)&&r&&a.responseText){var e=a.responseText;for(ae[i]=e,oe.push({url:i,size:e.length}),ne+=e.length,r(e);5242880<ne;){var t=oe.shift();ne-=t.size,delete ae[t.url]}}},a.open("GET",i),a.send(null),a}r&&r(ae[i])}(e,function(e){var t;try{t=JSON.parse(e)}catch(e){}i(t)})}}),he={loadedItems:{},items:[],getPixelFootprint:function(e){for(var t,i=new n(e.length),r=0,a=e.length-1;r<a;r+=2)t=this._map.project([e[r],e[r+1]],this._map.getZoom()),i[r]=t.x,i[r+1]=t.y;if(!((i=function(e){var t,i,r,a,o,n,s,l,h,f,c,d,u,g=e.length/2,p=new w(g),y=0,m=g-1,x=[],v=[],b=[];for(p[y]=p[m]=1;m;){for(i=0,t=y+1;t<m;t++)o=e[2*t],n=e[2*t+1],s=e[2*y],l=e[2*y+1],h=e[2*m],f=e[2*m+1],u=d=c=void 0,u=f-l,0==(d=h-s)&&0===u||(1<(c=((o-s)*d+(n-l)*u)/(d*d+u*u))?(s=h,l=f):0<c&&(s+=d*c,l+=u*c)),i<(r=(d=o-s)*d+(u=n-l)*u)&&(a=t,i=r);2<i&&(p[a]=1,x.push(y),v.push(a),x.push(a),v.push(m)),y=x.pop(),m=v.pop()}for(t=0;t<g;t++)p[t]&&b.push(e[2*t],e[2*t+1]);return b}(i)).length<8))return i},resetItems:function(){this.items=[],this.loadedItems={},ye.reset()},addRenderItems:function(e,t){for(var i,r,a,o=M.read(e),n=0,s=o.length;n<s;n++)a=(i=o[n]).id||[i.footprint[0],i.footprint[1],i.height,i.minHeight].join(","),this.loadedItems[a]||(r=this.scale(i))&&(r.scale=t?0:1,this.items.push(r),this.loadedItems[a]=1);!function(){if(se)return;se=setInterval(function(){for(var e=he.items,t=!1,i=0,r=e.length;i<r;i++)e[i].scale<1&&(e[i].scale+=.1,1<e[i].scale&&(e[i].scale=1),t=!0);me.render(),t||(clearInterval(se),se=null)},33)}()},scale:function(e){var t={},i=6/l(2,v-A);if(e.id&&(t.id=e.id),t.height=s(e.height/i,_),t.minHeight=isNaN(e.minHeight)?0:e.minHeight/i,!(t.minHeight>_)&&(t.footprint=this.getPixelFootprint(e.footprint),t.footprint)){if(t.center=function(e){for(var t=1/0,i=-1/0,r=1/0,a=-1/0,o=0,n=e.length-3;o<n;o+=2)t=s(t,e[o]),i=m(i,e[o]),r=s(r,e[o+1]),a=m(a,e[o+1]);return{x:t+(i-t)/2<<0,y:r+(a-r)/2<<0}}(t.footprint),e.radius&&(t.radius=e.radius*U),e.shape&&(t.shape=e.shape),e.roofShape&&(t.roofShape=e.roofShape),"cone"!==t.roofShape&&"dome"!==t.roofShape||t.shape||!function(e){var t,i=e.length;if(i<16)return!1;var r=1/0,a=-1/0,o=1/0,n=-1/0;for(t=0;t<i-1;t+=2)r=Math.min(r,e[t]),a=Math.max(a,e[t]),o=Math.min(o,e[t+1]),n=Math.max(n,e[t+1]);var s=a-r,l=n-o,h=s/l;if(h<.85||1.15<h)return!1;var f={x:r+s/2,y:o+l/2},c=(s+l)/4,d=c*c;for(t=0;t<i-1;t+=2){var u=Q({x:e[t],y:e[t+1]},f);if(u/d<.8||1.2<u/d)return!1}return!0}(t.footprint)||(t.shape="cylinder"),e.holes){var r;t.holes=[];for(var a=0,o=e.holes.length;a<o;a++)(r=this.getPixelFootprint(e.holes[a]))&&t.holes.push(r)}var n;if(e.wallColor&&(n=p.parse(e.wallColor))&&(n=n.alpha(Y),t.altColor=""+n.lightness(.8),t.wallColor=""+n),e.roofColor&&(n=p.parse(e.roofColor))&&(t.roofColor=""+n.alpha(Y)),e.relationId&&(t.relationId=e.relationId),t.hitColor=ye.idToColor(e.relationId||e.id),t.roofHeight=isNaN(e.roofHeight)?0:e.roofHeight/i,!(t.height+t.roofHeight<=t.minHeight))return t}},set:function(e){this.isStatic=!0,this.resetItems(),this._staticData=[e],this.addRenderItems(this._staticData[0],!0)},setMap:function(e){this._map=e},load:function(e,t){this.src=e||"https://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json".replace("{k}",t||"anonymous"),this.update()},update:function(){if(this.resetItems(),!(v<A))if(this.isStatic&&this._staticData)for(var e=0;e<this._staticData.length;e++)this.addRenderItems(this._staticData[e]);else if(this.src){var t,i,r=16<v?256<<v-16:256>>16-v,a=q/r<<0,o=N/r<<0,n=f((q+O)/r),s=f((N+E)/r),l=this;for(i=o;i<=s;i++)for(t=a;t<=n;t++)this.loadTile(t,i,16,h)}function h(e){l.addRenderItems(e)}},loadTile:function(e,t,i,r){var a="abcd"[(e+t)%4],o=this.src.replace("{s}",a).replace("{x}",e).replace("{y}",t).replace("{z}",i);return le.loadJSON(o,r)}},fe={draw:function(e,t,i,r,a,o,n,s){var l,h,f=this._extrude(e,t,r,a,o,n),c=[];if(i)for(l=0,h=i.length;l<h;l++)c[l]=this._extrude(e,i[l],r,a,o,n);if(e.fillStyle=s,e.beginPath(),this._ring(e,f),i)for(l=0,h=c.length;l<h;l++)this._ring(e,c[l]);e.closePath(),e.stroke(),e.fill()},_extrude:function(e,t,i,r,a,o){for(var n,s,l=K/(K-i),h=K/(K-r),f={x:0,y:0},c={x:0,y:0},d=[],u=0,g=t.length-3;u<g;u+=2)f.x=t[u]-q,f.y=t[u+1]-N,c.x=t[u+2]-q,c.y=t[u+3]-N,n=ue.project(f,l),s=ue.project(c,l),r&&(f=ue.project(f,h),c=ue.project(c,h)),(c.x-f.x)*(n.y-f.y)>(n.x-f.x)*(c.y-f.y)&&(f.x<c.x&&f.y<c.y||f.x>c.x&&f.y>c.y?e.fillStyle=o:e.fillStyle=a,e.beginPath(),this._ring(e,[c.x,c.y,f.x,f.y,n.x,n.y,s.x,s.y]),e.closePath(),e.fill()),d[u]=n.x,d[u+1]=n.y;return d},_ring:function(e,t){e.moveTo(t[0],t[1]);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i],t[i+1])},simplified:function(e,t,i){if(e.beginPath(),this._ringAbs(e,t),i)for(var r=0,a=i.length;r<a;r++)this._ringAbs(e,i[r]);e.closePath(),e.stroke(),e.fill()},_ringAbs:function(e,t){e.moveTo(t[0]-q,t[1]-N);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i]-q,t[i+1]-N)},shadow:function(e,t,i,r,a){for(var o,n,s=null,l={x:0,y:0},h={x:0,y:0},f=0,c=t.length-3;f<c;f+=2)l.x=t[f]-q,l.y=t[f+1]-N,h.x=t[f+2]-q,h.y=t[f+3]-N,o=pe.project(l,r),n=pe.project(h,r),a&&(l=pe.project(l,a),h=pe.project(h,a)),(h.x-l.x)*(o.y-l.y)>(o.x-l.x)*(h.y-l.y)?(1===s&&e.lineTo(l.x,l.y),s=0,f||e.moveTo(l.x,l.y),e.lineTo(h.x,h.y)):(0===s&&e.lineTo(o.x,o.y),s=1,f||e.moveTo(o.x,o.y),e.lineTo(n.x,n.y));if(i)for(f=0,c=i.length;f<c;f++)this._ringAbs(e,i[f])},shadowMask:function(e,t,i){if(this._ringAbs(e,t),i)for(var r=0,a=i.length;r<a;r++)this._ringAbs(e,i[r])},hitArea:function(e,t,i,r,a,o){var n,s,l=null,h={x:0,y:0},f={x:0,y:0},c=K/(K-r),d=K/(K-a);e.fillStyle=o,e.beginPath();for(var u=0,g=t.length-3;u<g;u+=2)h.x=t[u]-q,h.y=t[u+1]-N,f.x=t[u+2]-q,f.y=t[u+3]-N,n=ue.project(h,c),s=ue.project(f,c),a&&(h=ue.project(h,d),f=ue.project(f,d)),(f.x-h.x)*(n.y-h.y)>(n.x-h.x)*(f.y-h.y)?(1===l&&e.lineTo(h.x,h.y),l=0,u||e.moveTo(h.x,h.y),e.lineTo(f.x,f.y)):(0===l&&e.lineTo(n.x,n.y),l=1,u||e.moveTo(n.x,n.y),e.lineTo(s.x,s.y));e.closePath(),e.fill()}},ce={draw:function(e,t,i,r,a,o,n,s,l){var h,f,c={x:t.x-q,y:t.y-N},d=K/(K-a),u=K/(K-o),g=ue.project(c,d);r*=d,o&&(c=ue.project(c,u),i*=u);var p=this._tangents(c,i,g,r);p?(h=y(p[0].y1-c.y,p[0].x1-c.x),f=y(p[1].y1-c.y,p[1].x1-c.x)):f=h=1.5*T,e.fillStyle=n,e.beginPath(),e.arc(g.x,g.y,r,I,h,!0),e.arc(c.x,c.y,i,h,I),e.closePath(),e.fill(),e.fillStyle=s,e.beginPath(),e.arc(g.x,g.y,r,f,I,!0),e.arc(c.x,c.y,i,I,f),e.closePath(),e.fill(),e.fillStyle=l,this._circle(e,g,r)},simplified:function(e,t,i){this._circle(e,{x:t.x-q,y:t.y-N},i)},shadow:function(e,t,i,r,a,o){var n,s,l={x:t.x-q,y:t.y-N},h=pe.project(l,a);o&&(l=pe.project(l,o));var f=this._tangents(l,i,h,r);f?(n=y(f[0].y1-l.y,f[0].x1-l.x),s=y(f[1].y1-l.y,f[1].x1-l.x),e.moveTo(f[1].x2,f[1].y2),e.arc(h.x,h.y,r,s,n),e.arc(l.x,l.y,i,n,s)):(e.moveTo(l.x+i,l.y),e.arc(l.x,l.y,i,0,2*T))},shadowMask:function(e,t,i){var r={x:t.x-q,y:t.y-N};e.moveTo(r.x+i,r.y),e.arc(r.x,r.y,i,0,2*T)},hitArea:function(e,t,i,r,a,o,n){var s,l,h={x:t.x-q,y:t.y-N},f=K/(K-a),c=K/(K-o),d=ue.project(h,f);r*=f,o&&(h=ue.project(h,c),i*=c);var u=this._tangents(h,i,d,r);e.fillStyle=n,e.beginPath(),u?(s=y(u[0].y1-h.y,u[0].x1-h.x),l=y(u[1].y1-h.y,u[1].x1-h.x),e.moveTo(u[1].x2,u[1].y2),e.arc(d.x,d.y,r,l,s),e.arc(h.x,h.y,i,s,l)):(e.moveTo(h.x+i,h.y),e.arc(h.x,h.y,i,0,2*T)),e.closePath(),e.fill()},_circle:function(e,t,i){e.beginPath(),e.arc(t.x,t.y,i,0,2*T),e.stroke(),e.fill()},_tangents:function(e,t,i,r){var a=e.x-i.x,o=e.y-i.y,n=t-r,s=a*a+o*o;if(!(s<=n*n)){var l,h,f,c=x(s),d=-a/c,u=-o/c,g=n/c,p=[];l=x(m(0,1-g*g));for(var y=1;-1<=y;y-=2)h=d*g-y*l*u,f=u*g+y*l*d,p.push({x1:e.x+t*h<<0,y1:e.y+t*f<<0,x2:i.x+r*h<<0,y2:i.y+r*f<<0});return p}}},de={draw:function(e,t,i,r,a,o,n){for(var s={x:i.x-q,y:i.y-N},l=K/(K-r),h=K/(K-a),f=ue.project(s,l),c={x:0,y:0},d={x:0,y:0},u=0,g=t.length-3;u<g;u+=2)c.x=t[u]-q,c.y=t[u+1]-N,d.x=t[u+2]-q,d.y=t[u+3]-N,a&&(c=ue.project(c,h),d=ue.project(d,h)),(d.x-c.x)*(f.y-c.y)>(f.x-c.x)*(d.y-c.y)&&(c.x<d.x&&c.y<d.y||c.x>d.x&&c.y>d.y?e.fillStyle=n:e.fillStyle=o,e.beginPath(),this._triangle(e,c,d,f),e.closePath(),e.fill())},_triangle:function(e,t,i,r){e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.lineTo(r.x,r.y)},_ring:function(e,t){e.moveTo(t[0]-q,t[1]-N);for(var i=2,r=t.length-1;i<r;i+=2)e.lineTo(t[i]-q,t[i+1]-N)},shadow:function(e,t,i,r,a){for(var o={x:0,y:0},n={x:0,y:0},s={x:i.x-q,y:i.y-N},l=pe.project(s,r),h=0,f=t.length-3;h<f;h+=2)o.x=t[h]-q,o.y=t[h+1]-N,n.x=t[h+2]-q,n.y=t[h+3]-N,a&&(o=pe.project(o,a),n=pe.project(n,a)),(n.x-o.x)*(l.y-o.y)>(l.x-o.x)*(n.y-o.y)&&this._triangle(e,o,n,l)},shadowMask:function(e,t){this._ring(e,t)},hitArea:function(e,t,i,r,a,o){var n={x:i.x-q,y:i.y-N},s=K/(K-r),l=K/(K-a),h=ue.project(n,s),f={x:0,y:0},c={x:0,y:0};e.fillStyle=o,e.beginPath();for(var d=0,u=t.length-3;d<u;d+=2)f.x=t[d]-q,f.y=t[d+1]-N,c.x=t[d+2]-q,c.y=t[d+3]-N,a&&(f=ue.project(f,l),c=ue.project(c,l)),(c.x-f.x)*(h.y-f.y)>(h.x-f.x)*(c.y-f.y)&&this._triangle(e,f,c,h);e.closePath(),e.fill()}},ue={project:function(e,t){return{x:(e.x-k)*t+k<<0,y:(e.y-S)*t+S<<0}},render:function(){var e=this.context;if(e.clearRect(0,0,O,E),!(v<A||C)){var t,i,r,a,o,n,s,l={x:k+q,y:S+N},h=he.items;h.sort(function(e,t){return e.minHeight-t.minHeight||Q(t.center,l)-Q(e.center,l)||t.height-e.height});for(var f=0,c=h.length;f<c;f++)if(t=h[f],!ge.isSimple(t)&&re(a=t.footprint)){switch(i=t.scale<1?t.height*t.scale:t.height,r=0,t.minHeight&&(r=t.scale<1?t.minHeight*t.scale:t.minHeight),o=t.wallColor||W,n=t.altColor||X,s=t.roofColor||G,e.strokeStyle=n,t.shape){case"cylinder":ce.draw(e,t.center,t.radius,t.radius,i,r,o,n,s);break;case"cone":ce.draw(e,t.center,t.radius,0,i,r,o,n);break;case"dome":ce.draw(e,t.center,t.radius,t.radius/2,i,r,o,n);break;case"sphere":ce.draw(e,t.center,t.radius,t.radius,i,r,o,n,s);break;case"pyramid":de.draw(e,a,t.center,i,r,o,n);break;default:fe.draw(e,a,t.holes,i,r,o,n,s)}switch(t.roofShape){case"cone":ce.draw(e,t.center,t.radius,0,i+t.roofHeight,i,s,""+p.parse(s).lightness(.9));break;case"dome":ce.draw(e,t.center,t.radius,t.radius/2,i+t.roofHeight,i,s,""+p.parse(s).lightness(.9));break;case"pyramid":de.draw(e,a,t.center,i+t.roofHeight,i,s,p.parse(s).lightness(.9))}}}}},ge={maxZoom:A+2,maxHeight:5,isSimple:function(e){return v<=this.maxZoom&&e.height+e.roofHeight<this.maxHeight},render:function(){var e=this.context;if(e.clearRect(0,0,O,E),!(v<A||C||v>this.maxZoom))for(var t,i,r=he.items,a=0,o=r.length;a<o;a++)if(!((t=r[a]).height>=this.maxHeight)&&re(i=t.footprint))switch(e.strokeStyle=t.altColor||X,e.fillStyle=t.roofColor||G,t.shape){case"cylinder":case"cone":case"dome":case"sphere":ce.simplified(e,t.center,t.radius);break;default:fe.simplified(e,i,t.holes)}}},pe={enabled:!0,color:"#666666",blurColor:"#000000",blurSize:15,date:new Date,direction:{x:0,y:0},project:function(e,t){return{x:e.x+this.direction.x*t,y:e.y+this.direction.y*t}},render:function(){var e,t,i,r,a=this.context;if(a.clearRect(0,0,O,E),!(!this.enabled||v<A||C||(e=te(Z+q,F+N),(t=H(this.date,e.latitude,e.longitude)).altitude<=0))){r=(i=1/g(t.altitude))<5?.75:1/i*5,this.direction.x=u(t.azimuth)*i,this.direction.y=d(t.azimuth)*i;var o,n,s,l,h,f,c=he.items;for(a.canvas.style.opacity=r/(2*Y),a.shadowColor=this.blurColor,a.shadowBlur=this.blurSize*(Y/2),a.fillStyle=this.color,a.beginPath(),o=0,n=c.length;o<n;o++)if(re(f=(s=c[o]).footprint)){switch(l=s.scale<1?s.height*s.scale:s.height,l*=.2,h=0,s.minHeight&&(h=s.scale<1?s.minHeight*s.scale:s.minHeight),s.shape){case"cylinder":ce.shadow(a,s.center,s.radius,s.radius,l,h);break;case"cone":ce.shadow(a,s.center,s.radius,0,l,h);break;case"dome":ce.shadow(a,s.center,s.radius,s.radius/2,l,h);break;case"sphere":ce.shadow(a,s.center,s.radius,s.radius,l,h);break;case"pyramid":de.shadow(a,f,s.center,l,h);break;default:fe.shadow(a,f,s.holes,l,h)}switch(s.roofShape){case"cone":ce.shadow(a,s.center,s.radius,0,l+s.roofHeight,l);break;case"dome":ce.shadow(a,s.center,s.radius,s.radius/2,l+s.roofHeight,l);break;case"pyramid":de.shadow(a,f,s.center,l+s.roofHeight,l)}}for(a.closePath(),a.fill(),a.shadowBlur=null,a.globalCompositeOperation="destination-out",a.beginPath(),o=0,n=c.length;o<n;o++)if(re(f=(s=c[o]).footprint)&&!s.minHeight)switch(s.shape){case"cylinder":case"cone":case"dome":ce.shadowMask(a,s.center,s.radius);break;default:fe.shadowMask(a,f,s.holes)}a.fillStyle="#00ff00",a.fill(),a.globalCompositeOperation="source-over"}}},ye={_idMapping:[null],reset:function(){this._idMapping=[null]},render:function(){if(!this._timer){var e=this;this._timer=setTimeout(function(){e._timer=null,e._render()},500)}},_render:function(){var e=this.context;if(e.clearRect(0,0,O,E),!(v<A||C)){var t,i,r,a,o,n={x:k+q,y:S+N},s=he.items;s.sort(function(e,t){return e.minHeight-t.minHeight||Q(t.center,n)-Q(e.center,n)||t.height-e.height});for(var l=0,h=s.length;l<h;l++)if((o=(t=s[l]).hitColor)&&re(a=t.footprint)){switch(i=t.height,r=0,t.minHeight&&(r=t.minHeight),t.shape){case"cylinder":ce.hitArea(e,t.center,t.radius,t.radius,i,r,o);break;case"cone":ce.hitArea(e,t.center,t.radius,0,i,r,o);break;case"dome":ce.hitArea(e,t.center,t.radius,t.radius/2,i,r,o);break;case"sphere":ce.hitArea(e,t.center,t.radius,t.radius,i,r,o);break;case"pyramid":de.hitArea(e,a,t.center,i,r,o);break;default:fe.hitArea(e,a,t.holes,i,r,o)}switch(t.roofShape){case"cone":ce.hitArea(e,t.center,t.radius,0,i+t.roofHeight,i,o);break;case"dome":ce.hitArea(e,t.center,t.radius,t.radius/2,i+t.roofHeight,i,o);break;case"pyramid":de.hitArea(e,a,t.center,i+t.roofHeight,i,o)}}O&&E&&(this._imageData=this.context.getImageData(0,0,O,E).data)}},getIdFromXY:function(e,t){var i=this._imageData;if(i){var r=4*((0|t)*O+(0|e)),a=i[r]|i[r+1]<<8|i[r+2]<<16;return this._idMapping[a]}},idToColor:function(e){var t=this._idMapping.indexOf(e);return-1===t&&(this._idMapping.push(e),t=this._idMapping.length-1),"rgb("+[255&t,t>>8&255,t>>16&255].join(",")+")"}};var me={container:document.createElement("DIV"),items:[],init:function(){this.container.style.pointerEvents="none",this.container.style.position="absolute",this.container.style.left=0,this.container.style.top=0,pe.context=this.createContext(this.container),ge.context=this.createContext(this.container),ue.context=this.createContext(this.container),ye.context=this.createContext()},render:function(e){c(function(){e||(pe.render(),ge.render(),ye.render()),ue.render()})},createContext:function(e){var t=document.createElement("CANVAS");t.style.transform="translate3d(0, 0, 0)",t.style.imageRendering="optimizeSpeed",t.style.position="absolute",t.style.left=0,t.style.top=0;var i=t.getContext("2d");return i.lineCap="round",i.lineJoin="round",i.lineWidth=1,i.imageSmoothingEnabled=!1,this.items.push(t),e&&e.appendChild(t),i},appendTo:function(e){e.appendChild(this.container)},remove:function(){this.container.parentNode.removeChild(this.container)},setSize:function(e,t){for(var i=0,r=this.items.length;i<r;i++)this.items[i].width=e,this.items[i].height=t},setPosition:function(e,t){this.container.style.left=e+"px",this.container.style.top=t+"px"}};function xe(e){q=e.x,N=e.y}function ve(e){k=Z+e.x,S=E+e.y,me.render(!0)}function be(e){O=e.width,E=e.height,F=E/2<<0,k=Z=O/2<<0,S=E,me.setSize(O,E),_=K-50}function we(e){b=z<<(v=e);var t=te(q+Z,N+F),i=ie(t.latitude,0),r=ie(t.latitude,1);U=r.x-i.x,Y=l(.95,v-A),W=""+V.alpha(Y),X=""+B.alpha(Y),G=""+J.alpha(Y)}me.init();var _e=function(e){this.offset={x:0,y:0},e&&(he.setMap(e),e.addLayer(this))},ke=_e.prototype=L.Layer?new L.Layer:{};ke.addTo=function(e){return e.addLayer(this),he.setMap(e),this},ke.onAdd=function(e){this.map=e,me.appendTo(e._panes.overlayPane);var t=this.getOffset(),i=e.getPixelOrigin();be({width:e._size.x,height:e._size.y}),xe({x:i.x-t.x,y:i.y-t.y}),we(e._zoom),me.setPosition(-t.x,-t.y),e.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset,click:this.onClick},this),e.options.zoomAnimation&&e.on("zoomanim",this.onZoom,this),e.attributionControl&&e.attributionControl.addAttribution(P),he.update()},ke.onRemove=function(){var e=this.map;e.attributionControl&&e.attributionControl.removeAttribution(P),e.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd,resize:this.onResize,viewreset:this.onViewReset,click:this.onClick},this),e.options.zoomAnimation&&e.off("zoomanim",this.onZoom,this),me.remove(),e=null},ke.onMove=function(e){var t=this.getOffset();ve({x:this.offset.x-t.x,y:this.offset.y-t.y})},ke.onMoveEnd=function(e){if(this.noMoveEnd)this.noMoveEnd=!1;else{var t=this.map,i=this.getOffset(),r=t.getPixelOrigin();this.offset=i,me.setPosition(-i.x,-i.y),ve({x:0,y:0}),be({width:t._size.x,height:t._size.y}),xe({x:r.x-i.x,y:r.y-i.y}),me.render(),he.update()}},ke.onZoomStart=function(e){C=!0,me.render()},ke.onZoom=function(e){},ke.onZoomEnd=function(e){var t,i=this.map,r=this.getOffset(),a=i.getPixelOrigin();xe({x:a.x-r.x,y:a.y-r.y}),t={zoom:i._zoom},C=!1,we(t.zoom),he.update(),me.render(),this.noMoveEnd=!0},ke.onResize=function(){},ke.onViewReset=function(){var e=this.getOffset();this.offset=e,me.setPosition(-e.x,-e.y),ve({x:0,y:0})},ke.onClick=function(e){var t=ye.getIdFromXY(e.containerPoint.x,e.containerPoint.y);t&&Ce({feature:t,lat:e.latlng.lat,lon:e.latlng.lng})},ke.getOffset=function(){return L.DomUtil.getPosition(this.map._mapPane)},ke.style=function(e){var t;return(t=(e=e||{}).color||e.wallColor)&&(V=p.parse(t),W=""+V.alpha(Y),B=V.lightness(.8),X=""+B.alpha(Y),J=V.lightness(1.2),G=""+J.alpha(Y)),e.roofColor&&(J=p.parse(e.roofColor),G=""+J.alpha(Y)),void 0!==e.shadows&&(pe.enabled=!!e.shadows),me.render(),this},ke.date=function(e){return pe.date=e,pe.render(),this},ke.load=function(e){return he.load(e),this},ke.set=function(e){return he.set(e),this};var Se=function(){};ke.each=function(t){return Se=function(e){return t(e)},this};var Ce=function(){};ke.click=function(t){return Ce=function(e){return t(e)},this},_e.VERSION="0.2.2b",_e.ATTRIBUTION=P,_e.minZoom=function(e){if(!e)return A;A=e},_e.initMinZoom=function(e){e&&(A=e._getBuildingMinScaleID())},_e.prototype.addData=function(e){he._staticData?(he._staticData.push(e),he.addRenderItems(e)):this.set(e)},_e.prototype.getData=function(e){if(he._staticData)for(var t=0;t<he._staticData.length;t++)for(var i=0;i<he._staticData[t].features.length;i++)if(he._staticData[t].features[i]._building_id===e)return he._staticData[t].features[i];return null},_e.prototype.clearData=function(){he._staticData=[],he.update(),pe.render(),ge.render(),ye.render(),ue.render()},_e.prototype.delData=function(e){if(he._staticData)for(var t=0;t<he._staticData.length;t++)for(var i=0;i<he._staticData[t].features.length;i++)if(he._staticData[t].features[i]._building_id===e)return he._staticData[t].features.splice(i,1),delete he.loadedItems[e],he.update(),pe.render(),ge.render(),ye.render(),void ue.render()},_e.prototype.includes=function(e){return!!he.loadedItems[e]},e.OSMBuildings=_e}(this);